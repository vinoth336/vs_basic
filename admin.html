<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vs Vegetables - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .admin-header {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .admin-header h1 {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
        }

        .admin-header p {
            text-align: center;
            opacity: 0.9;
            margin-top: 0.5rem;
        }

        /* Navigation Tabs */
        .nav-tabs {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .nav-tabs-list {
            display: flex;
            list-style: none;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 150px;
        }

        .nav-tab button {
            width: 100%;
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .nav-tab button:hover {
            background: #f8f9fa;
            color: #28a745;
        }

        .nav-tab button.active {
            color: #28a745;
            border-bottom-color: #28a745;
            background: #f8f9fa;
        }

        /* Main Content Area */
        .main-content {
            min-height: 600px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
        }

        /* Product Order Styles */
        .order-controls {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        /* Combo/Offer Product Checkbox List */
        .product-checkbox-list {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
        }

        .product-checkbox-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .product-checkbox-item:hover {
            background: #f8f9fa;
        }

        .product-checkbox-item:last-child {
            border-bottom: none;
        }

        .product-checkbox-item input[type="checkbox"] {
            margin-right: 1rem;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .product-checkbox-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
            margin-right: 1rem;
        }

        .product-checkbox-info {
            flex: 1;
        }

        .product-checkbox-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }

        .product-checkbox-details {
            font-size: 0.85rem;
            color: #6c757d;
        }

        /* Sequence List Styles */
        .sequence-list {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }

        .sequence-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            background: white;
        }

        .sequence-item:last-child {
            border-bottom: none;
        }

        .sequence-item-name {
            flex: 1;
            font-weight: 500;
            color: #2c3e50;
        }

        .sequence-item-controls {
            display: flex;
            gap: 0.5rem;
        }

        .sequence-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #495057;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .sequence-btn:hover:not(:disabled) {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .sequence-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .product-category-tag {
            display: inline-block;
            background: #e7f3ff;
            color: #0066cc;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 4px;
            border: 1px solid #b3d9ff;
        }

        .order-product-list {
            min-height: 400px;
            background: white;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            align-items: start;
        }

        .order-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            cursor: move;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            user-select: none;
            height: fit-content;
            min-height: 120px;
        }

        .order-item:hover {
            background: #f8f9fa;
            border-color: #28a745;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .order-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            z-index: 1000;
        }

        .order-item-drag-handle {
            color: #6c757d;
            font-size: 1.2rem;
            cursor: grab;
        }

        .order-item-drag-handle:active {
            cursor: grabbing;
        }

        .order-item-info {
            flex: 1;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .order-item-image {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .order-item-details h4 {
            margin: 0;
            font-size: 1rem;
            color: #333;
        }

        .order-item-details p {
            margin: 0;
            font-size: 0.85rem;
            color: #666;
        }

        .order-item-position {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .drop-zone {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #dee2e6;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #28a745;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #28a745;
            color: #28a745;
        }

        .btn-outline:hover {
            background: #28a745;
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-label.required::after {
            content: " *";
            color: #dc3545;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .form-control.error {
            border-color: #dc3545;
        }

        .form-help {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .form-error {
            font-size: 0.85rem;
            color: #dc3545;
            margin-top: 0.25rem;
        }

        /* Grid Layouts */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .grid-5 {
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            align-items: center;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #28a745;
        }

        /* Lists */
        .list-group {
            list-style: none;
        }

        .list-item {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item:hover {
            background: #f8f9fa;
        }

        /* Status Badges */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Search and Filter */
        .search-filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 1rem;
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .filter-select {
            min-width: 150px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: block;
        }

        .modal-content {
            background-color: white;
            margin: 2vh auto;
            padding: 0;
            border-radius: 10px;
            width: 95%;
            max-width: 900px;
            height: 96vh;
            display: flex;
            flex-direction: column;
            position: relative;
            animation: slideIn 0.3s ease;
            overflow: hidden;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            flex-shrink: 0;
            padding: 1rem 1.5rem;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            z-index: 10;
            position: relative;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #28a745;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            min-height: 0;
            /* Important for flex child with overflow */
            scroll-behavior: smooth;
        }

        .modal-footer {
            flex-shrink: 0;
            /* Prevent footer from shrinking */
            padding: 1rem 1.5rem;
            border-top: 2px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            background: white;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
            position: relative;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
        }

        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transform: translateX(400px);
            transition: all 0.3s ease;
            border-left: 4px solid #28a745;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: #dc3545;
        }

        .toast.warning {
            border-left-color: #ffc107;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
            margin-left: auto;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }

            .main-content {
                padding: 1rem;
            }

            .search-filter-bar {
                flex-direction: column;
            }

            .search-box {
                min-width: auto;
            }

            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
            }

            .grid-5 {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .section-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .modal-content {
                width: 95%;
                margin: 2% auto;
            }
        }

        /* Loading States */
        .loading {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #28a745;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Form Sections */
        .form-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #fafbfc;
            position: relative;
            clear: both;
        }

        .form-section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #28a745;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-section-title::before {
            content: "";
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            border-radius: 2px;
        }

        /* Image Management */
        .image-input-group {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .image-preview {
            min-height: 60px;
            border: 2px dashed #e9ecef;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            position: relative;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 120px;
            border-radius: 8px;
            object-fit: cover;
        }

        .image-preview.loading {
            background: linear-gradient(90deg,
                    #f0f0f0 25%,
                    transparent 37%,
                    #f0f0f0 63%);
            background-size: 400% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 100% 50%;
            }

            100% {
                background-position: -100% 50%;
            }
        }

        /* Budget Options */
        .budget-options-grid {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .budget-option-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .budget-option-item:last-child {
            margin-bottom: 0;
        }

        /* Combo Builder */
        .combo-items-container {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .combo-item {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .combo-item:last-child {
            margin-bottom: 0;
        }

        .combo-product-select {
            min-width: 200px;
        }

        /* Product Cards */
        .product-card {
            position: relative;
            overflow: hidden;
        }

        .product-card .product-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
        }

        .product-card .product-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .product-card:hover .product-actions {
            opacity: 1;
        }

        /* Product Image Styling */
        .product-card img {
            width: 80px !important;
            height: 80px !important;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            background: white;
        }

        .product-card .product-icon {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .product-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 0 0 10px 10px;
            margin: 1rem -1.5rem -1.5rem -1.5rem;
        }

        .product-stat {
            text-align: center;
        }

        .product-stat-label {
            display: block;
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .product-stat-value {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: #28a745;
        }

        /* Offer Section */
        .offer-preview {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            margin-top: 1rem;
        }

        .offer-preview-label {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .offer-preview-price {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .offer-preview-original {
            text-decoration: line-through;
            opacity: 0.8;
            font-size: 1rem;
        }

        /* Filter and Search Enhancements */
        .advanced-filters {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .advanced-filters.collapsed .filter-content {
            display: none;
        }

        .filter-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 1rem;
        }

        .filter-content {
            display: block;
        }

        .quick-filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .quick-filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e9ecef;
            background: white;
            color: #666;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .quick-filter-btn:hover,
        .quick-filter-btn.active {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        /* Loading States */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .loading-skeleton {
            background: linear-gradient(90deg,
                    #f0f0f0 25%,
                    transparent 37%,
                    #f0f0f0 63%);
            background-size: 400% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        /* Price & Stock Table Styles */
        .price-stock-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .price-stock-table th,
        .price-stock-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .price-stock-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #28a745;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .price-stock-table tr:hover {
            background: rgba(40, 167, 69, 0.05);
        }

        .price-stock-table tr.modified {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
        }

        .product-name-cell {
            min-width: 200px;
        }

        .product-icon {
            font-size: 1.2rem;
            margin-right: 8px;
        }

        .product-name-main {
            font-weight: 600;
            color: #333;
        }

        .product-name-secondary {
            font-size: 0.85rem;
            color: #666;
            margin-top: 2px;
        }

        .category-badge {
            padding: 2px 8px;
            background: #e9ecef;
            color: #495057;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .price-edit-cell {
            position: relative;
            min-width: 120px;
        }

        .price-input {
            width: 100%;
            max-width: 100px;
            padding: 4px 8px;
            border: 2px solid transparent;
            border-radius: 4px;
            background: transparent;
            font-size: 1rem;
            font-weight: 600;
            color: #28a745;
        }

        .price-input:hover,
        .price-input:focus {
            border-color: #28a745;
            background: white;
            outline: none;
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.1);
        }

        .price-input.modified {
            border-color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
        }

        .price-input.error {
            border-color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        .stock-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .stock-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .stock-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #dc3545;
            transition: 0.3s;
            border-radius: 34px;
        }

        .stock-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked+.stock-slider {
            background-color: #28a745;
        }

        input:checked+.stock-slider:before {
            transform: translateX(26px);
        }

        .stock-slider.modified {
            box-shadow: 0 0 0 2px #ffc107;
        }

        .stock-status-text {
            margin-left: 10px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .stock-status-text.available {
            color: #28a745;
        }

        .stock-status-text.unavailable {
            color: #dc3545;
        }

        .product-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .bulk-actions-disabled .btn {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .changes-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ffc107;
            color: #212529;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .changes-indicator.show {
            transform: translateX(0);
        }

        .table-container {
            max-height: 70vh;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .table-actions {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .table-actions .btn {
            padding: 4px 8px;
            font-size: 0.75rem;
            border-radius: 3px;
        }

        .modified-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #ffc107;
            border-radius: 50%;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        /* Responsive adjustments for Price & Stock table */
        @media (max-width: 768px) {
            .price-stock-table {
                font-size: 0.85rem;
            }

            .price-stock-table th,
            .price-stock-table td {
                padding: 8px 4px;
            }

            .product-name-cell {
                min-width: 150px;
            }

            .price-input {
                max-width: 80px;
            }

            .stock-toggle {
                width: 50px;
                height: 28px;
            }

            .stock-slider:before {
                height: 20px;
                width: 20px;
                left: 4px;
                bottom: 4px;
            }

            input:checked+.stock-slider:before {
                transform: translateX(22px);
            }

            .bulk-actions .d-flex {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* Utility Classes */
        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .text-muted {
            color: #666;
        }

        .text-success {
            color: #28a745;
        }

        .text-danger {
            color: #dc3545;
        }

        .text-warning {
            color: #ffc107;
        }

        .mb-1 {
            margin-bottom: 0.5rem;
        }

        .mb-2 {
            margin-bottom: 1rem;
        }

        .mb-3 {
            margin-bottom: 1.5rem;
        }

        .mt-1 {
            margin-top: 0.5rem;
        }

        .mt-2 {
            margin-top: 1rem;
        }

        .mt-3 {
            margin-top: 1.5rem;
        }

        .d-none {
            display: none;
        }

        .d-block {
            display: block;
        }

        .d-flex {
            display: flex;
        }

        .align-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-1 {
            gap: 0.5rem;
        }

        .gap-2 {
            gap: 1rem;
        }

        .w-100 {
            width: 100%;
        }

        .flex-1 {
            flex: 1;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="admin-header">
        <div class="container">
            <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                <div>
                    <h1>
                        <i class="fas fa-cog"></i> Vs Vegetables Admin Panel
                    </h1>
                    <p>
                        Manage your product catalog, categories, and
                        configuration
                    </p>
                </div>
                <div>
                    <label style="
                                color: white;
                                font-weight: 600;
                                margin-right: 10px;
                            ">Language:</label>
                    <select id="language-selector" class="form-control" style="width: auto; display: inline-block"
                        onchange="switchLanguage(this.value)">
                        <option value="en">English</option>
                        <option value="ta">Tamil</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="nav-tabs">
        <div class="container">
            <ul class="nav-tabs-list">
                <li class="nav-tab">
                    <button class="nav-tab-btn active" data-tab="products">
                        <i class="fas fa-boxes"></i>
                        Products
                    </button>
                </li>
                <li class="nav-tab">
                    <button class="nav-tab-btn" data-tab="categories">
                        <i class="fas fa-tags"></i>
                        Categories
                    </button>
                </li>
                <li class="nav-tab">
                    <button class="nav-tab-btn" data-tab="price-stock">
                        <i class="fas fa-dollar-sign"></i>
                        Price & Stock
                    </button>
                </li>
                <li class="nav-tab">
                    <button class="nav-tab-btn" data-tab="product-order">
                        <i class="fas fa-sort"></i>
                        Product Order
                    </button>
                </li>
                <li class="nav-tab">
                    <button class="nav-tab-btn" data-tab="combos">
                        <i class="fas fa-box-open"></i>
                        Combos
                    </button>
                </li>
                <li class="nav-tab">
                    <button class="nav-tab-btn" data-tab="offers">
                        <i class="fas fa-tags"></i>
                        Offers
                    </button>
                </li>
                <li class="nav-tab">
                    <button class="nav-tab-btn" data-tab="sequences">
                        <i class="fas fa-arrows-alt-v"></i>
                        Sequences
                    </button>
                </li>
                <li class="nav-tab">
                    <button class="nav-tab-btn" data-tab="import-export">
                        <i class="fas fa-exchange-alt"></i>
                        Import/Export
                    </button>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <div class="main-content">
            <!-- Products Tab -->
            <div id="products-tab" class="tab-content active">
                <div class="section-header">
                    <h2 class="section-title">Product Management</h2>
                    <button class="btn btn-primary" id="add-product-btn">
                        <i class="fas fa-plus"></i>
                        Add Product
                    </button>
                </div>

                <!-- Search and Filter -->
                <div class="search-filter-bar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="product-search" placeholder="Search products..." />
                    </div>
                    <select class="form-control filter-select" id="category-filter">
                        <option value="">All Categories</option>
                    </select>
                    <select class="form-control filter-select" id="status-filter">
                        <option value="">All Status</option>
                        <option value="available">Available</option>
                        <option value="unavailable">Unavailable</option>
                    </select>
                </div>

                <!-- Products List -->
                <div id="products-list" class="grid grid-3">
                    <!-- Products will be populated here -->
                </div>

                <!-- Empty State -->
                <div id="products-empty" class="text-center mt-3 d-none">
                    <i class="fas fa-box-open text-muted" style="font-size: 3rem; margin-bottom: 1rem"></i>
                    <h3 class="text-muted">No products found</h3>
                    <p class="text-muted">
                        Add your first product to get started
                    </p>
                    <button class="btn btn-primary mt-2" onclick="showProductModal()">
                        <i class="fas fa-plus"></i>
                        Add First Product
                    </button>
                </div>
            </div>

            <!-- Categories Tab -->
            <div id="categories-tab" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Category Management</h2>
                    <button class="btn btn-primary" id="add-category-btn">
                        <i class="fas fa-plus"></i>
                        Add Category
                    </button>
                </div>

                <!-- Categories List -->
                <div id="categories-list">
                    <!-- Categories will be populated here -->
                </div>

                <!-- Empty State -->
                <div id="categories-empty" class="text-center mt-3 d-none">
                    <i class="fas fa-tags text-muted" style="font-size: 3rem; margin-bottom: 1rem"></i>
                    <h3 class="text-muted">No categories found</h3>
                    <p class="text-muted">
                        Add your first category to organize products
                    </p>
                    <button class="btn btn-primary mt-2" onclick="showCategoryModal()">
                        <i class="fas fa-plus"></i>
                        Add First Category
                    </button>
                </div>
            </div>

            <!-- Price & Stock Tab -->
            <div id="price-stock-tab" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">
                        Quick Price & Stock Management
                    </h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" id="whatsapp-list-btn" onclick="generateWhatsAppList()"
                            title="Generate WhatsApp price list">
                            <i class="fab fa-whatsapp"></i>
                            WhatsApp Price List
                        </button>
                        <button class="btn btn-success" id="bulk-save-btn" onclick="saveBulkChanges()" disabled>
                            <i class="fas fa-save"></i>
                            Save All Changes
                        </button>
                        <button class="btn btn-outline" id="reset-changes-btn" onclick="resetAllChanges()">
                            <i class="fas fa-undo"></i>
                            Reset Changes
                        </button>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-3 mb-3">
                    <div class="card text-center">
                        <div class="card-title">Total Products</div>
                        <div class="text-success" style="font-size: 2rem; font-weight: bold" id="total-products-count">
                            0
                        </div>
                    </div>
                    <div class="card text-center">
                        <div class="card-title">Available</div>
                        <div class="text-success" style="font-size: 2rem; font-weight: bold"
                            id="available-products-count">
                            0
                        </div>
                    </div>
                    <div class="card text-center">
                        <div class="card-title">Out of Stock</div>
                        <div class="text-danger" style="font-size: 2rem; font-weight: bold" id="out-of-stock-count">
                            0
                        </div>
                    </div>
                </div>

                <!-- Search and Filter -->
                <div class="search-filter-bar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="price-stock-search" placeholder="Search products..." />
                    </div>
                    <select class="form-control filter-select" id="price-stock-category-filter">
                        <option value="">All Categories</option>
                    </select>
                    <select class="form-control filter-select" id="price-stock-status-filter">
                        <option value="">All Status</option>
                        <option value="available">Available</option>
                        <option value="unavailable">Out of Stock</option>
                        <option value="modified">Modified</option>
                    </select>
                    <button class="btn btn-outline" onclick="clearPriceStockFilters()">
                        <i class="fas fa-times"></i>
                        Clear
                    </button>
                </div>

                <!-- Bulk Actions -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-layer-group"></i>
                            Bulk Actions
                        </h3>
                    </div>
                    <div>
                        <div class="d-flex gap-2 flex-wrap">
                            <div class="d-flex align-center gap-2">
                                <input type="checkbox" id="select-all-products" onchange="toggleSelectAll(this)" />
                                <label for="select-all-products" class="form-label">Select All</label>
                            </div>
                            <div class="d-flex align-center gap-2">
                                <button class="btn btn-sm btn-success" onclick="bulkSetAvailable(true)" disabled
                                    id="bulk-available-btn">
                                    <i class="fas fa-check"></i>
                                    Set Available
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="bulkSetAvailable(false)" disabled
                                    id="bulk-unavailable-btn">
                                    <i class="fas fa-times"></i>
                                    Set Out of Stock
                                </button>
                            </div>
                            <div class="d-flex align-center gap-2">
                                <input type="number" id="bulk-price-input" placeholder="New price" class="form-control"
                                    style="width: 120px" min="0" step="0.01" />
                                <button class="btn btn-sm btn-outline" onclick="bulkUpdatePrice()" disabled
                                    id="bulk-price-btn">
                                    <i class="fas fa-tags"></i>
                                    Update Price
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Table -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-table"></i>
                            Products List
                        </h3>
                        <span class="badge badge-info" id="filtered-count">0 products</span>
                    </div>
                    <div id="price-stock-table-container">
                        <!-- Table will be populated here -->
                    </div>
                </div>

                <!-- Empty State -->
                <div id="price-stock-empty" class="text-center mt-3 d-none">
                    <i class="fas fa-box-open text-muted" style="font-size: 3rem; margin-bottom: 1rem"></i>
                    <h3 class="text-muted">No products found</h3>
                    <p class="text-muted">
                        Add some products first or adjust your filters
                    </p>
                </div>
            </div>

            <!-- Product Order Tab -->
            <div id="product-order-tab" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">
                        Global Product Order Management
                    </h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="saveProductOrder()">
                            <i class="fas fa-save"></i>
                            Save Order
                        </button>
                        <button class="btn btn-secondary" onclick="resetProductOrder()">
                            <i class="fas fa-undo"></i>
                            Reset Order
                        </button>
                    </div>
                </div>

                <!-- Global Ordering Info -->
                <div class="order-controls">
                    <div class="alert alert-info" style="margin: 0;">
                        <i class="fas fa-info-circle"></i>
                        <strong>Global Product Ordering:</strong> Drag and drop products below to set their display
                        order across ALL categories on your website. This overrides category-based ordering.
                    </div>
                </div>

                <!-- Draggable Product List -->
                <div id="orderProductList" class="order-product-list">
                    <div class="empty-state">
                        <i class="fas fa-info-circle"></i>
                        <h3>Loading products for global ordering...</h3>
                        <p>Choose a category from the dropdown above to see its products and drag them to reorder.</p>
                    </div>
                </div>
            </div>

            <!-- Import/Export Tab -->
            <div id="import-export-tab" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">
                        Import/Export Configuration
                    </h2>
                </div>

                <div class="grid grid-2">
                    <!-- Import Section -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-upload"></i>
                                Import Configuration
                            </h3>
                        </div>
                        <div>
                            <div class="form-group">
                                <label class="form-label">Upload JSON File</label>
                                <input type="file" class="form-control" id="import-file" accept=".json" />
                                <div class="form-help">
                                    Select a JSON configuration file to
                                    import
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Or Paste JSON</label>
                                <textarea class="form-control" id="import-text" rows="8"
                                    placeholder="Paste your JSON configuration here..."></textarea>
                            </div>
                            <button class="btn btn-primary w-100" id="import-btn">
                                <i class="fas fa-upload"></i>
                                Import Configuration
                            </button>
                        </div>
                    </div>

                    <!-- Export Section -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-download"></i>
                                Export Configuration
                            </h3>
                        </div>
                        <div>
                            <div class="form-group">
                                <label class="form-label">Export Options</label>
                                <div class="d-flex gap-2 mb-2">
                                    <button class="btn btn-outline flex-1" id="export-json-btn">
                                        <i class="fas fa-file-code"></i>
                                        Download JSON
                                    </button>
                                    <button class="btn btn-outline flex-1" id="copy-json-btn">
                                        <i class="fas fa-copy"></i>
                                        Copy JSON
                                    </button>
                                </div>
                                <button class="btn btn-secondary w-100" id="copy-js-btn">
                                    <i class="fas fa-code"></i>
                                    Copy as JavaScript
                                </button>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Configuration Preview</label>
                                <textarea class="form-control" id="export-preview" rows="8" readonly
                                    placeholder="Configuration will appear here..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Auto-save Status -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-save"></i>
                            Auto-save Status
                        </h3>
                    </div>
                    <div>
                        <div class="d-flex align-center justify-between mb-2">
                            <span>Last saved:</span>
                            <span id="last-saved" class="text-muted">Never</span>
                        </div>
                        <div class="d-flex align-center justify-between mb-2">
                            <span>Changes pending:</span>
                            <span id="changes-pending" class="badge badge-info">0</span>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success flex-1" id="save-draft-btn">
                                <i class="fas fa-save"></i>
                                Save Draft
                            </button>
                            <button class="btn btn-secondary flex-1" id="load-draft-btn">
                                <i class="fas fa-folder-open"></i>
                                Load Draft
                            </button>
                            <button class="btn btn-danger flex-1" id="clear-draft-btn">
                                <i class="fas fa-trash"></i>
                                Clear Draft
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Combos Tab -->
            <div id="combos-tab" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-box-open"></i>
                        Combo Deals Management
                    </h2>
                    <button class="btn btn-primary" onclick="showComboModal()">
                        <i class="fas fa-plus"></i>
                        Add New Combo
                    </button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Existing Combos</h3>
                    </div>
                    <div>
                        <div id="combos-list" class="product-checkbox-list">
                            <!-- Combos will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Offers Tab -->
            <div id="offers-tab" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-tags"></i>
                        Special Offers Management
                    </h2>
                    <button class="btn btn-success" onclick="saveOffers()">
                        <i class="fas fa-save"></i>
                        Save Offers
                    </button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Set Price & Quantity Overrides</h3>
                    </div>
                    <div>
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle"></i>
                            Override price and quantity for products to create special offers. Leave blank to use
                            original values.
                        </div>
                        <div class="search-box mb-3">
                            <i class="fas fa-search"></i>
                            <input type="text" id="offer-search" placeholder="Search products..."
                                oninput="renderOffersList(this.value)" />
                        </div>
                        <div id="offers-products-list" style="max-height: 600px; overflow-y: auto;">
                            <!-- Products with override inputs will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sequences Tab -->
            <div id="sequences-tab" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-arrows-alt-v"></i>
                        Sequence Management
                    </h2>
                    <button class="btn btn-success" id="save-sequences-btn">
                        <i class="fas fa-save"></i>
                        Save All Sequences
                    </button>
                </div>

                <div class="grid grid-2">
                    <!-- Tag Order Section -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-tag"></i>
                                Tag Display Order
                            </h3>
                        </div>
                        <div>
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle"></i>
                                Control the order in which tags appear. Use the arrows to reorder.
                            </div>
                            <div id="tag-order-list" class="sequence-list">
                                <!-- Tag order items will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Category Order Section -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-layer-group"></i>
                                Category Display Order
                            </h3>
                        </div>
                        <div>
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle"></i>
                                Control the order categories appear in the sidebar. Use the arrows to reorder.
                            </div>
                            <div id="category-order-list" class="sequence-list">
                                <!-- Category order items will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Product Modal -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="product-modal-title">
                    Add Product
                </h3>
                <button class="modal-close" onclick="hideProductModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="product-form">
                    <input type="hidden" id="product-id" name="id" />
                    <input type="hidden" id="product-category" name="category" />

                    <!-- Basic Information -->
                    <div class="form-section">
                        <h4 class="form-section-title">
                            Basic Information
                        </h4>
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label class="form-label required">Product ID</label>
                                <input type="text" class="form-control" id="product-id-input" name="idInput" required />
                                <div class="form-help">
                                    Unique identifier (auto-generated from
                                    English name)
                                </div>
                                <div class="form-error" id="product-id-error"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required">Category</label>
                                <select class="form-control" id="product-category-select" name="categorySelect"
                                    required>
                                    <option value="">
                                        Select Category
                                    </option>
                                </select>
                                <div class="form-help">
                                    Choose the product category
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-2">
                            <div class="form-group">
                                <label class="form-label required">English Name</label>
                                <input type="text" class="form-control" id="product-name-en" name="nameEn" required />
                                <div class="form-help">
                                    Product name in English
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required">Tamil Name</label>
                                <input type="text" class="form-control" id="product-name-ta" name="nameTa" required />
                                <div class="form-help">
                                    Product name in Tamil
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-2">
                            <div class="form-group">
                                <label class="form-label required">Price</label>
                                <input type="number" class="form-control" id="product-price" name="price" required
                                    min="0" step="0.01" onchange="calculateDisplayAmount();" />
                                <div class="form-help">Price in </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required">Unit Type</label>
                                <select class="form-control" id="product-unit" name="unit" required
                                    onchange="toggleCustomUnit(this)">
                                    <option value="Kg">Kg</option>
                                    <option value="Grams">Grams</option>
                                    <option value="Pcs">Pcs</option>
                                    <option value="Bunch">Bunch</option>
                                    <option value="Litre">Litre</option>
                                    <option value="Box">Box</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <input type="text" class="form-control mt-2" id="custom-unit-input" name="customUnit"
                                    placeholder="Enter custom unit..." style="display: none" />
                                <div class="form-help">
                                    Unit type (kg, grams, bunch, etc.)
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-3">
                            <div class="form-group">
                                <label class="form-label required">Display Unit</label>
                                <select class="form-control" id="product-display-unit" name="displayUnit"
                                    onchange="toggleCustomDisplayUnit(this); calculateDisplayAmount();" required>
                                    <option value="Kg">Kg</option>
                                    <option value="Grams">Grams</option>
                                    <option value="Pcs">Pcs</option>
                                    <option value="Bunch">Bunch</option>
                                    <option value="Litre">Litre</option>
                                    <option value="Box">Box</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <input type="text" class="form-control mt-2" id="custom-display-unit-input"
                                    name="customDisplayUnit" placeholder="Enter custom unit..." style="display: none"
                                    onchange="calculateDisplayAmount();" />
                                <div class="form-help">
                                    Unit shown to customers
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required">Display Value</label>
                                <input type="number" class="form-control" id="product-display-unit-value"
                                    name="displayUnitValue" required min="0" step="0.01" placeholder="e.g., 250, 0.5, 1"
                                    onchange="calculateDisplayAmount();" />
                                <div class="form-help">
                                    Quantity shown to customers
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required">Amount (\u20b9)</label>
                                <input type="number" class="form-control" id="product-display-amount"
                                    name="displayAmount" required min="0" step="0.01" placeholder="Auto-calculated"
                                    readonly style="background-color: #f8f9fa" />
                                <div class="form-help">
                                    Price for display quantity
                                    (auto-calculated)
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-2">
                            <div class="form-group">
                                <label class="form-label required">Master Unit Value</label>
                                <input type="number" class="form-control" id="product-unit-value" name="unitValue"
                                    required min="0" step="0.01" placeholder="e.g., 1, 0.5, 1000"
                                    onchange="calculateDisplayAmount();" />
                                <div class="form-help">
                                    Master quantity for pricing calculations
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required">Master Unit</label>
                                <select class="form-control" id="product-unit" name="unit" required
                                    onchange="toggleCustomUnit(this); calculateDisplayAmount();">
                                    <option value="Kg">Kg</option>
                                    <option value="Grams">Grams</option>
                                    <option value="Pcs">Pcs</option>
                                    <option value="Bunch">Bunch</option>
                                    <option value="Litre">Litre</option>
                                    <option value="Box">Box</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <input type="text" class="form-control mt-2" id="custom-unit-input" name="customUnit"
                                    placeholder="Enter custom unit..." style="display: none"
                                    onchange="calculateDisplayAmount();" />
                                <div class="form-help">
                                    Master unit for pricing calculations
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Icon/Emoji</label>
                            <div class="d-flex gap-2">
                                <input type="text" class="form-control" id="product-icon" name="icon" maxlength="2"
                                    placeholder="" />
                                <button type="button" class="btn btn-outline" onclick="showEmojiPicker('product-icon')">
                                    <i class="fas fa-smile"></i>
                                </button>
                            </div>
                            <div class="form-help">
                                Choose an emoji or icon
                            </div>
                        </div>
                    </div>

                    <!-- Images -->
                    <div class="form-section">
                        <h4 class="form-section-title">Images</h4>
                        <div class="form-group">
                            <label class="form-label">Image URLs</label>
                            <div id="product-images-container">
                                <div class="image-input-group">
                                    <div class="d-flex gap-2">
                                        <input type="url" class="form-control" name="images[]"
                                            placeholder="https://example.com/image.jpg" />
                                        <button type="button" class="btn btn-outline" onclick="previewImage(this)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-danger" onclick="removeImageInput(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    <div class="image-preview mt-2"></div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline mt-2" onclick="addImageInput()">
                                <i class="fas fa-plus"></i> Add Another
                                Image
                            </button>
                            <div class="form-help">
                                Add product images (URLs only)
                            </div>
                        </div>
                    </div>

                    <!-- Availability & Tags -->
                    <div class="form-section">
                        <h4 class="form-section-title">
                            Availability & Tags
                        </h4>
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label class="form-label">Availability</label>
                                <div class="d-flex align-center gap-2">
                                    <input type="checkbox" id="product-available" name="available" checked />
                                    <label for="product-available">Product is available for
                                        purchase</label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tags</label>
                                <div class="tags-container">
                                    <div class="d-flex align-center gap-2 mb-2">
                                        <input type="checkbox" id="tag-new-arrival" name="tags[]" value="new-arrival" />
                                        <label for="tag-new-arrival">New Arrival</label>
                                    </div>
                                    <div class="d-flex align-center gap-2">
                                        <input type="checkbox" id="tag-combo" name="tags[]" value="combo" />
                                        <label for="tag-combo">Combo Product</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Easy Pick -->
                    <div class="form-section">
                        <h4 class="form-section-title">Easy Pick</h4>
                        <div class="form-group">
                            <div class="d-flex align-center gap-2 mb-2">
                                <input type="checkbox" id="product-easy-pick" name="isEasyPick"
                                    onchange="toggleEasyPickOptions()" />
                                <label for="product-easy-pick">Enable Easy Pick for this product</label>
                            </div>
                            <div class="form-help mb-2">
                                Easy Pick allows customers to quickly select preset quantities
                            </div>
                            <div id="easy-pick-options-container" class="d-none">
                                <label class="form-label">Preset Quantities</label>
                                <div class="easy-pick-presets-grid">
                                    <div class="d-flex gap-2 mb-2">
                                        <input type="number" class="form-control" id="easy-pick-preset-value"
                                            placeholder="e.g., 0.5, 1, 2" min="0.01" step="0.01" />
                                        <input type="text" class="form-control" id="easy-pick-preset-label"
                                            placeholder="e.g., 500g, 1kg" />
                                        <button type="button" class="btn btn-outline" onclick="addEasyPickPreset()">
                                            <i class="fas fa-plus"></i> Add
                                        </button>
                                    </div>
                                </div>
                                <div id="easy-pick-presets-list"></div>
                                <div class="form-help">
                                    Add preset quantities (e.g., 0.5 = "500g", 1 = "1kg"). Unit should match the
                                    product's master unit.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Budget Pick -->
                    <div class="form-section">
                        <h4 class="form-section-title">Budget Options</h4>
                        <div class="form-group">
                            <div class="d-flex align-center gap-2 mb-2">
                                <input type="checkbox" id="product-budget-pick" name="isBudgetPick"
                                    onchange="toggleBudgetOptions()" />
                                <label for="product-budget-pick">This is a Budget Pick product</label>
                            </div>
                            <div id="budget-options-container" class="d-none">
                                <label class="form-label">Budget Price Options</label>
                                <div class="budget-options-grid">
                                    <div class="d-flex gap-2 mb-2">
                                        <input type="number" class="form-control" placeholder="5" min="1" />
                                        <button type="button" class="btn btn-outline" onclick="addBudgetOption(this)">
                                            Add
                                        </button>
                                    </div>
                                </div>
                                <div id="budget-options-list"></div>
                                <div class="form-help">
                                    Add alternative budget pricing options
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Special Offers -->
                    <div class="form-section">
                        <h4 class="form-section-title">Special Offers</h4>
                        <div class="form-group">
                            <div class="d-flex align-center gap-2 mb-2">
                                <input type="checkbox" id="product-has-offer" name="hasOffer"
                                    onchange="toggleOfferSection()" />
                                <label for="product-has-offer">This product has a special offer</label>
                            </div>
                            <div id="offer-section" class="d-none">
                                <div class="grid grid-2">
                                    <div class="form-group">
                                        <label class="form-label">Offer Type</label>
                                        <select class="form-control" id="offer-type" name="offerType">
                                            <option value="discount">
                                                Percentage Discount
                                            </option>
                                            <option value="price">
                                                Fixed Price
                                            </option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Offer Value</label>
                                        <input type="number" class="form-control" id="offer-value" name="offerValue"
                                            min="0" step="0.01" />
                                        <div class="form-help">
                                            Percentage (e.g., 20) or fixed
                                            price (e.g., 50)
                                        </div>
                                    </div>
                                </div>

                                <div class="grid grid-2">
                                    <div class="form-group">
                                        <label class="form-label">Offer Label (English)</label>
                                        <input type="text" class="form-control" id="offer-label-en" name="offerLabelEn"
                                            placeholder="20% OFF" />
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Offer Label (Tamil)</label>
                                        <input type="text" class="form-control" id="offer-label-ta" name="offerLabelTa"
                                            placeholder="20% " />
                                    </div>
                                </div>

                                <div class="grid grid-2">
                                    <div class="form-group">
                                        <label class="form-label">Valid From</label>
                                        <input type="date" class="form-control" id="offer-valid-from"
                                            name="offerValidFrom" />
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Valid Until</label>
                                        <input type="date" class="form-control" id="offer-valid-until"
                                            name="offerValidUntil" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Combo Builder -->
                    <div class="form-section">
                        <h4 class="form-section-title">Combo Builder</h4>
                        <div class="form-group">
                            <div class="d-flex align-center gap-2 mb-2">
                                <input type="checkbox" id="product-is-combo" name="isCombo"
                                    onchange="toggleComboBuilder()" />
                                <label for="product-is-combo">This is a combo product</label>
                            </div>
                            <div id="combo-builder-section" class="d-none">
                                <div class="form-group mb-3">
                                    <label class="form-label">Combo Minimum Price ()</label>
                                    <input type="number" id="combo-minimum" name="comboMinimum"
                                        placeholder="Minimum amount" class="form-control" min="1" step="1" />
                                    <small class="text-muted">Minimum amount users can enter for
                                        this combo</small>
                                </div>
                                <div class="combo-items-container">
                                    <div class="combo-item">
                                        <div class="grid grid-5">
                                            <select class="form-control combo-product-select" name="comboProducts[]">
                                                <option value="">
                                                    Select Product
                                                </option>
                                            </select>
                                            <input type="text" class="form-control" name="comboUnits[]"
                                                placeholder="Unit (optional)" />
                                            <input type="number" class="form-control" name="comboUnitValues[]"
                                                placeholder="Unit Value (optional)" step="0.1" min="0" />
                                            <input type="number" class="form-control" name="comboQuantities[]"
                                                placeholder="Amount" min="1" />
                                            <button type="button" class="btn btn-danger"
                                                onclick="removeComboItem(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline mt-2" onclick="addComboItem()">
                                    <i class="fas fa-plus"></i> Add Product
                                    to Combo
                                </button>
                                <div class="form-help">
                                    Select products that are included in
                                    this combo
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideProductModal()">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary" form="product-form">
                    Save Product
                </button>
            </div>
        </div>
    </div>

    <!-- Combo Modal -->
    <div id="combo-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="combo-modal-title">Add Combo Deal</h3>
                <button class="modal-close" onclick="hideComboModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="combo-form" onsubmit="saveCombo(event)">
                    <input type="hidden" id="combo-id" />

                    <!-- Basic Information -->
                    <div class="form-section">
                        <h4 class="form-section-title">Basic Information</h4>
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label class="form-label required">Name (English)</label>
                                <input type="text" class="form-control" id="combo-name-en" required />
                            </div>
                            <div class="form-group">
                                <label class="form-label required">Name (Tamil)</label>
                                <input type="text" class="form-control" id="combo-name-ta" required />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Combo Price ()</label>
                            <input type="number" class="form-control" id="combo-price" required min="0" step="1" />
                            <div class="form-help">Total price for this combo</div>
                        </div>
                    </div>

                    <!-- Products Selection -->
                    <div class="form-section">
                        <h4 class="form-section-title">Products in Combo</h4>
                        <div class="form-group">
                            <label class="form-label">Search & Add Products</label>
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="combo-product-search" placeholder="Search products..."
                                    oninput="searchComboProducts(this.value)" />
                            </div>
                            <div id="combo-product-search-results"
                                style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; margin-top: 8px; display: none;">
                                <!-- Search results will appear here -->
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Selected Items</label>
                            <div id="combo-items-list"
                                style="border: 1px solid #dee2e6; border-radius: 8px; padding: 12px; min-height: 100px;">
                                <p class="text-muted" style="margin: 0;">No items added yet. Search and add products
                                    above.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Image Upload -->
                    <div class="form-section">
                        <h4 class="form-section-title">Combo Image</h4>
                        <div class="form-group">
                            <label class="form-label">Upload Custom Image (Optional)</label>
                            <input type="file" class="form-control" id="combo-image-upload" accept="image/*"
                                onchange="handleComboImageUpload(event)" />
                            <div class="form-help">Or generate a collage automatically from product images</div>
                            <button type="button" class="btn btn-secondary" onclick="generateComboCollage()"
                                style="margin-top: 8px;">
                                <i class="fas fa-magic"></i> Generate Collage
                            </button>
                        </div>
                        <div id="combo-image-preview" style="margin-top: 12px; display: none;">
                            <img src="" alt="Combo preview" style="max-width: 200px; border-radius: 8px;" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideComboModal()">Cancel</button>
                <button type="submit" form="combo-form" class="btn btn-primary">Save Combo</button>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="category-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="category-modal-title">
                    Add Category
                </h3>
                <button class="modal-close" onclick="hideCategoryModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="category-form">
                    <input type="hidden" id="category-key" name="key" />

                    <div class="grid grid-2">
                        <div class="form-group">
                            <label class="form-label required">Category Key</label>
                            <input type="text" class="form-control" id="category-key-input" name="keyInput" required />
                            <div class="form-help">
                                Unique identifier (auto-generated from
                                English name)
                            </div>
                            <div class="form-error" id="category-key-error"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Icon/Emoji</label>
                            <div class="d-flex gap-2">
                                <input type="text" class="form-control" id="category-icon" name="icon" maxlength="2"
                                    placeholder="" />
                                <button type="button" class="btn btn-outline"
                                    onclick="showEmojiPicker('category-icon')">
                                    <i class="fas fa-smile"></i>
                                </button>
                            </div>
                            <div class="form-help">
                                Choose an emoji or icon for this category
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-2">
                        <div class="form-group">
                            <label class="form-label required">English Name</label>
                            <input type="text" class="form-control" id="category-name-en" name="nameEn" required />
                            <div class="form-help">
                                Category name in English
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label required">Tamil Name</label>
                            <input type="text" class="form-control" id="category-name-ta" name="nameTa" required />
                            <div class="form-help">
                                Category name in Tamil
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-2">
                        <div class="form-group">
                            <label class="form-label required">Display Order</label>
                            <input type="number" class="form-control" id="category-order" name="order" required min="1"
                                value="1" />
                            <div class="form-help">
                                Order in which category appears (1 = first)
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Visibility</label>
                            <div class="d-flex align-center gap-2">
                                <input type="checkbox" id="category-visible" name="visible" checked />
                                <label for="category-visible">Show this category to customers</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideCategoryModal()">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary" form="category-form">
                    Save Category
                </button>
            </div>
        </div>
    </div>

    <!-- WhatsApp Price List Modal -->
    <div id="whatsapp-modal" class="modal">
        <div class="modal-content" style="max-width: 600px">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fab fa-whatsapp" style="color: #25d366"></i>
                    WhatsApp Price List Generator
                </h3>
                <button class="modal-close" onclick="hideWhatsAppModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Category Filter Options -->
                <div class="form-group">
                    <label class="form-label">Include Categories</label>
                    <div id="whatsapp-category-filters" class="d-flex flex-wrap gap-2 mb-3">
                        <!-- Category checkboxes will be populated here -->
                    </div>
                    <div class="form-help">
                        Select which categories to include in the price list
                    </div>
                </div>

                <!-- Price Display Options -->
                <div class="form-group">
                    <label class="form-label">Price Display Options</label>
                    <div class="d-flex flex-column gap-2 mb-2">
                        <div class="d-flex align-center gap-2">
                            <input type="checkbox" id="show-master-value" onchange="regenerateWhatsAppPreview()"
                                checked />
                            <label for="show-master-value">Show Master Value (Rs X per kg/unit)</label>
                        </div>
                        <div class="d-flex align-center gap-2">
                            <input type="checkbox" id="show-display-value" onchange="regenerateWhatsAppPreview()" />
                            <label for="show-display-value">Show Display Value (e.g., 250g for 20)</label>
                        </div>
                    </div>
                    <div class="form-help">
                        Choose how to display prices in the WhatsApp message
                    </div>
                </div>

                <!-- Options -->
                <div class="form-group">
                    <div class="d-flex align-center gap-2">
                        <input type="checkbox" id="include-out-of-stock" onchange="regenerateWhatsAppPreview()" />
                        <label for="include-out-of-stock">Include out-of-stock items</label>
                    </div>
                    <div class="d-flex align-center gap-2">
                        <input type="checkbox" id="group-by-category" onchange="regenerateWhatsAppPreview()" checked />
                        <label for="group-by-category">Group by category</label>
                    </div>
                </div>

                <!-- Preview -->
                <div class="form-group">
                    <label class="form-label">Preview</label>
                    <div style="
                                border: 2px solid #e9ecef;
                                border-radius: 8px;
                                padding: 1rem;
                                background: #f8f9fa;
                                max-height: 400px;
                                overflow-y: auto;
                            ">
                        <pre id="whatsapp-preview" style="
                                    margin: 0;
                                    font-family: monospace;
                                    white-space: pre-wrap;
                                    word-wrap: break-word;
                                    font-size: 0.9rem;
                                    line-height: 1.4;
                                ">
Generating preview...</pre>
                    </div>
                    <div class="form-help">
                        This is how your price list will look in WhatsApp
                    </div>
                </div>

                <!-- Statistics -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h4 class="card-title">Statistics</h4>
                    </div>
                    <div class="d-flex justify-between align-center">
                        <div>
                            <span id="whatsapp-product-count">0</span>
                            products
                        </div>
                        <div>
                            <span id="whatsapp-category-count">0</span>
                            categories
                        </div>
                        <div>
                            Approx
                            <span id="whatsapp-char-count">0</span>
                            characters
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideWhatsAppModal()">
                    Cancel
                </button>
                <button type="button" class="btn btn-outline" onclick="regenerateWhatsAppPreview()">
                    <i class="fas fa-refresh"></i>
                    Refresh Preview
                </button>
                <button type="button" class="btn btn-success" onclick="copyWhatsAppList()" id="copy-whatsapp-btn">
                    <i class="fab fa-whatsapp"></i>
                    Copy to Clipboard
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        // Global state management
        let config = {
            categories: {},
            products: {},
            localization: {
                en: {},
                ta: {},
            },
        };

        // Language management
        let currentLanguage = "en";

        let currentEditingProduct = null;
        let currentEditingCategory = null;
        let hasUnsavedChanges = false;

        // Initialize the application
        document.addEventListener("DOMContentLoaded", function () {
            initializeApp();
        });

        async function initializeApp() {
            try {
                // Load existing configuration
                await loadConfiguration();

                // Setup event listeners
                setupEventListeners();

                // Setup form validation
                setupRealTimeValidation();
                setupCategoryKeyGeneration();

                // Render initial content
                renderProducts();
                renderCategories();
                updateExportPreview();

                // Setup auto-save
                setupAutoSave();

                // Load any existing draft
                const draftTime = localStorage.getItem(
                    "vs-vegetables-admin-draft-time",
                );
                if (draftTime) {
                    document.getElementById("last-saved").textContent =
                        formatDate(new Date(draftTime));
                }

                // Run data integrity check
                const integrityIssues = validateDataIntegrity();
                if (integrityIssues.length > 0) {
                    console.warn(
                        "Data integrity issues found:",
                        integrityIssues,
                    );
                    showToast(
                        `Found ${integrityIssues.length} data integrity issue(s). Check console for details.`,
                        "warning",
                    );
                }

                showToast("Admin panel loaded successfully", "success");

                // Show helpful statistics
                const stats = getConfigurationStats();
                console.log("Configuration loaded:", stats);
            } catch (error) {
                console.error("Failed to initialize app:", error);
                showToast(
                    "Failed to load configuration: " + error.message,
                    "error",
                );

                // Fallback: initialize with empty config
                config = {
                    categories: {},
                    products: {},
                    localization: { en: {}, ta: {} },
                };

                renderProducts();
                renderCategories();
                updateExportPreview();
            }
        }

        // Event listeners setup
        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll(".nav-tab-btn").forEach((btn) => {
                btn.addEventListener("click", function () {
                    switchTab(this.dataset.tab);
                });
            });

            // Add buttons
            document
                .getElementById("add-product-btn")
                .addEventListener("click", () => showProductModal());
            document
                .getElementById("add-category-btn")
                .addEventListener("click", () => showCategoryModal());

            // Search and filters
            document
                .getElementById("product-search")
                .addEventListener("input", debounce(filterProducts, 300));
            document
                .getElementById("category-filter")
                .addEventListener("change", filterProducts);
            document
                .getElementById("status-filter")
                .addEventListener("change", filterProducts);

            // Import/Export
            document
                .getElementById("import-file")
                .addEventListener("change", handleFileImport);
            document
                .getElementById("import-btn")
                .addEventListener("click", importConfiguration);
            document
                .getElementById("export-json-btn")
                .addEventListener("click", exportJSON);
            document
                .getElementById("copy-json-btn")
                .addEventListener("click", copyJSON);
            document
                .getElementById("copy-js-btn")
                .addEventListener("click", copyJS);

            // Draft management
            document
                .getElementById("save-draft-btn")
                .addEventListener("click", saveDraft);
            document
                .getElementById("load-draft-btn")
                .addEventListener("click", loadDraft);
            document
                .getElementById("clear-draft-btn")
                .addEventListener("click", clearDraft);

            // Form submissions
            document
                .getElementById("product-form")
                .addEventListener("submit", saveProduct);
            document
                .getElementById("category-form")
                .addEventListener("submit", saveCategory);

            // Initialize Price & Stock event listeners
            initializePriceStockEventListeners();

            // Warn about unsaved changes
            window.addEventListener("beforeunload", function (e) {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = "";
                }
            });
        }

        // Language switching
        function switchLanguage(language) {
            currentLanguage = language;
            document.getElementById("language-selector").value = language;

            // Update all displays that show category names
            populateProductCategoryOptions();
            populateComboProductOptions();
            renderCategories();
            renderProducts();
            renderPriceStockTab();
        }

        function getCategoryName(category) {
            if (!category || !category.name) return "Unnamed Category";
            return (
                category.name[currentLanguage] ||
                category.name.en ||
                category.name.ta ||
                "Unnamed Category"
            );
        }

        function getProductName(product) {
            if (!product || !product.name) return "Unnamed Product";
            return (
                product.name[currentLanguage] ||
                product.name.en ||
                product.name.ta ||
                "Unnamed Product"
            );
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll(".nav-tab-btn").forEach((btn) => {
                btn.classList.remove("active");
            });
            document
                .querySelector(`[data-tab="${tabName}"]`)
                .classList.add("active");

            // Update tab content
            document.querySelectorAll(".tab-content").forEach((content) => {
                content.classList.remove("active");
            });
            document
                .getElementById(`${tabName}-tab`)
                .classList.add("active");

            // Update export preview when switching to import/export tab
            if (tabName === "import-export") {
                updateExportPreview();
            }

            // Initialize Price & Stock tab when switching to it
            if (tabName === "price-stock") {
                renderPriceStockTab();
            }

            // Initialize Product Order tab when switching to it
            if (tabName === "product-order") {
                initializeProductOrderTab();
            }

            // Initialize Combos tab when switching to it
            if (tabName === "combos") {
                initializeCombosTab();
            }

            // Initialize Offers tab when switching to it
            if (tabName === "offers") {
                initializeOffersTab();
            }

            // Initialize Sequences tab when switching to it
            if (tabName === "sequences") {
                initializeSequencesTab();
            }
        }

        // Load configuration from config.json
        async function loadConfiguration() {
            try {
                const response = await fetch("config.json");
                if (response.ok) {
                    config = await response.json();
                } else {
                    // Initialize with empty configuration if file doesn't exist
                    config = {
                        categories: {},
                        products: {},
                        localization: {
                            en: {},
                            ta: {},
                        },
                    };
                }
            } catch (error) {
                console.warn(
                    "Could not load config.json, starting with empty configuration",
                );
                config = {
                    categories: {},
                    products: {},
                    localization: {
                        en: {},
                        ta: {},
                    },
                };
            }
        }

        // Utility functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function generateId(name) {
            return name
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, "")
                .replace(/\s+/g, "-")
                .replace(/-+/g, "-")
                .trim()
                .replace(/^-|-$/g, "");
        }

        function formatPrice(price) {
            return `${price}`;
        }

        function formatDate(date) {
            return new Date(date).toLocaleString();
        }

        // Toast notifications
        function showToast(message, type = "success") {
            const toast = document.createElement("div");
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === "success" ? "check-circle" : type === "error" ? "exclamation-circle" : "info-circle"}"></i>
                <span>${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            document.getElementById("toast-container").appendChild(toast);

            // Show the toast
            setTimeout(() => toast.classList.add("show"), 100);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // Mark changes as pending
        function markChanges() {
            hasUnsavedChanges = true;
            updateChangesStatus();
        }

        function updateChangesStatus() {
            const pendingCount =
                Object.keys(config.products).length +
                Object.keys(config.categories).length;
            document.getElementById("changes-pending").textContent =
                pendingCount;
        }

        // Auto-save functionality
        function setupAutoSave() {
            setInterval(() => {
                if (hasUnsavedChanges) {
                    saveDraft();
                }
            }, 30000); // Auto-save every 30 seconds
        }

        function saveDraft() {
            try {
                localStorage.setItem(
                    "vs-vegetables-admin-draft",
                    JSON.stringify(config),
                );
                localStorage.setItem(
                    "vs-vegetables-admin-draft-time",
                    new Date().toISOString(),
                );
                document.getElementById("last-saved").textContent =
                    formatDate(new Date());
                showToast("Draft saved successfully", "success");
            } catch (error) {
                showToast(
                    "Failed to save draft: " + error.message,
                    "error",
                );
            }
        }

        function loadDraft() {
            try {
                const draft = localStorage.getItem(
                    "vs-vegetables-admin-draft",
                );
                if (draft) {
                    config = JSON.parse(draft);
                    renderProducts();
                    renderCategories();
                    updateExportPreview();
                    const saveTime = localStorage.getItem(
                        "vs-vegetables-admin-draft-time",
                    );
                    if (saveTime) {
                        document.getElementById("last-saved").textContent =
                            formatDate(new Date(saveTime));
                    }
                    showToast("Draft loaded successfully", "success");
                } else {
                    showToast("No draft found", "warning");
                }
            } catch (error) {
                showToast(
                    "Failed to load draft: " + error.message,
                    "error",
                );
            }
        }

        function clearDraft() {
            if (
                confirm(
                    "Are you sure you want to clear the saved draft? This action cannot be undone.",
                )
            ) {
                localStorage.removeItem("vs-vegetables-admin-draft");
                localStorage.removeItem("vs-vegetables-admin-draft-time");
                document.getElementById("last-saved").textContent = "Never";
                showToast("Draft cleared", "success");
            }
        }

        // Category Management Functions
        function renderCategories() {
            const categoriesList =
                document.getElementById("categories-list");
            const categoriesEmpty =
                document.getElementById("categories-empty");

            if (!categoriesList) return;

            const categories = Object.entries(config.categories || {});

            if (categories.length === 0) {
                categoriesList.style.display = "none";
                categoriesEmpty.classList.remove("d-none");
                return;
            }

            categoriesList.style.display = "block";
            categoriesEmpty.classList.add("d-none");

            // Sort categories by order
            categories.sort(
                ([, a], [, b]) => (a.order || 0) - (b.order || 0),
            );

            categoriesList.innerHTML = categories
                .map(([key, category]) => {
                    const productCount = Object.values(
                        config.products || {},
                    )
                        .flat()
                        .filter(
                            (product) =>
                                product &&
                                Object.keys(config.products || {}).find(
                                    (cat) =>
                                        config.products[cat].includes(
                                            product,
                                        ),
                                ) === key,
                        ).length;

                    return `
                    <div class="card category-item" data-key="${key}">
                        <div class="card-header">
                            <div class="d-flex align-center gap-2">
                                <span class="category-icon" style="font-size: 1.5rem;">${category.icon || ""}</span>
                                <div>
                                    <h4 class="card-title mb-1">${getCategoryName(category)}</h4>
                                    <p class="text-muted mb-0">${currentLanguage === "en" ? category.name?.ta || "" : category.name?.en || ""}</p>
                                </div>
                            </div>
                            <div class="d-flex align-center gap-2">
                                <span class="badge ${category.visible ? "badge-success" : "badge-danger"}">
                                    ${category.visible ? "Visible" : "Hidden"}
                                </span>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline" onclick="toggleCategoryActions('${key}')">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div class="dropdown-menu" id="category-actions-${key}">
                                        <button class="dropdown-item" onclick="editCategory('${key}')">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button class="dropdown-item" onclick="duplicateCategory('${key}')">
                                            <i class="fas fa-copy"></i> Duplicate
                                        </button>
                                        <button class="dropdown-item text-danger" onclick="deleteCategory('${key}')">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="category-stats">
                            <div class="grid grid-3">
                                <div class="stat-item">
                                    <span class="stat-label">Products</span>
                                    <span class="stat-value">${productCount}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Order</span>
                                    <span class="stat-value">#${category.order || 1}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Status</span>
                                    <span class="stat-value ${category.visible ? "text-success" : "text-danger"}">
                                        ${category.visible ? "Active" : "Inactive"}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                })
                .join("");

            // Update category filter dropdown
            updateCategoryFilter();
        }

        function showCategoryModal(key = null) {
            currentEditingCategory = key;
            const modal = document.getElementById("category-modal");
            const title = document.getElementById("category-modal-title");
            const form = document.getElementById("category-form");

            if (key) {
                title.textContent = "Edit Category";
                populateCategoryForm(config.categories[key], key);
            } else {
                title.textContent = "Add Category";
                form.reset();
                // Set next order number
                const maxOrder = Math.max(
                    0,
                    ...Object.values(config.categories || {}).map(
                        (c) => c.order || 0,
                    ),
                );
                document.getElementById("category-order").value =
                    maxOrder + 1;
            }

            modal.classList.add("show");
        }

        function hideCategoryModal() {
            document
                .getElementById("category-modal")
                .classList.remove("show");
            currentEditingCategory = null;
        }

        function populateCategoryForm(category, key) {
            document.getElementById("category-key").value = key;
            document.getElementById("category-key-input").value = key;
            document.getElementById("category-icon").value =
                category.icon || "";
            document.getElementById("category-name-en").value =
                category.name?.en || "";
            document.getElementById("category-name-ta").value =
                category.name?.ta || "";
            document.getElementById("category-order").value =
                category.order || 1;
            document.getElementById("category-visible").checked =
                category.visible !== false;

            // Disable key editing for existing categories
            document.getElementById("category-key-input").disabled = true;
        }

        function saveCategory(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const key =
                currentEditingCategory ||
                generateId(formData.get("nameEn"));

            // Validate category key uniqueness for new categories
            if (!currentEditingCategory && config.categories[key]) {
                showToast("Category key already exists", "error");
                return;
            }

            const categoryData = {
                name: {
                    en: formData.get("nameEn").trim(),
                    ta: formData.get("nameTa").trim(),
                },
                icon: formData.get("icon").trim(),
                order: parseInt(formData.get("order")) || 1,
                visible: formData.has("visible"),
            };

            // Validate required fields
            if (!categoryData.name.en) {
                showToast("English name is required", "error");
                return;
            }

            if (!categoryData.name.ta) {
                showToast("Tamil name is required", "error");
                return;
            }

            if (!categoryData.icon) {
                showToast("Icon is required", "error");
                return;
            }

            // Initialize categories if not exists
            if (!config.categories) {
                config.categories = {};
            }

            // Initialize products for this category if not exists
            if (!config.products) {
                config.products = {};
            }

            if (!config.products[key]) {
                config.products[key] = [];
            }

            config.categories[key] = categoryData;

            markChanges();
            renderCategories();
            hideCategoryModal();

            showToast(
                `Category ${currentEditingCategory ? "updated" : "created"} successfully`,
                "success",
            );
        }

        function editCategory(key) {
            showCategoryModal(key);
        }

        function duplicateCategory(key) {
            const category = config.categories[key];
            if (!category) return;

            const newKey = `${key}-copy`;
            let counter = 1;
            let finalKey = newKey;

            while (config.categories[finalKey]) {
                finalKey = `${newKey}-${counter}`;
                counter++;
            }

            config.categories[finalKey] = {
                ...category,
                name: {
                    en: `${category.name.en} (Copy)`,
                    ta: `${category.name.ta} ()`,
                },
                order:
                    Math.max(
                        0,
                        ...Object.values(config.categories).map(
                            (c) => c.order || 0,
                        ),
                    ) + 1,
            };

            config.products[finalKey] = [];

            markChanges();
            renderCategories();
            showToast("Category duplicated successfully", "success");
        }

        function deleteCategory(key) {
            const category = config.categories[key];
            if (!category) return;

            const productCount = (config.products[key] || []).length;

            let confirmMessage = `Are you sure you want to delete the category "${category.name.en}"?`;
            if (productCount > 0) {
                confirmMessage += `\n\nThis category contains ${productCount} product(s). They will be moved to an "Uncategorized" category.`;
            }

            if (confirm(confirmMessage)) {
                // Move products to uncategorized if any exist
                if (productCount > 0) {
                    if (!config.categories.uncategorized) {
                        config.categories.uncategorized = {
                            name: {
                                en: "Uncategorized",
                                ta: "",
                            },
                            icon: "",
                            order: 999,
                            visible: true,
                        };
                    }

                    if (!config.products.uncategorized) {
                        config.products.uncategorized = [];
                    }

                    config.products.uncategorized.push(
                        ...config.products[key],
                    );
                }

                delete config.categories[key];
                delete config.products[key];

                markChanges();
                renderCategories();
                showToast("Category deleted successfully", "success");
            }
        }

        function toggleCategoryActions(key) {
            const dropdown = document.getElementById(
                `category-actions-${key}`,
            );
            const isVisible = dropdown.style.display === "block";

            // Hide all other dropdowns
            document.querySelectorAll(".dropdown-menu").forEach((menu) => {
                menu.style.display = "none";
            });

            dropdown.style.display = isVisible ? "none" : "block";
        }

        function updateCategoryFilter() {
            const filter = document.getElementById("category-filter");
            if (!filter) return;

            const currentValue = filter.value;
            filter.innerHTML = '<option value="">All Categories</option>';

            Object.entries(config.categories || {}).forEach(
                ([key, category]) => {
                    const option = document.createElement("option");
                    option.value = key;
                    option.textContent = getCategoryName(category);
                    filter.appendChild(option);
                },
            );

            filter.value = currentValue;
        }

        // Auto-generate category key from English name
        function setupCategoryKeyGeneration() {
            const nameEnInput = document.getElementById("category-name-en");
            const keyInput = document.getElementById("category-key-input");

            if (nameEnInput && keyInput) {
                nameEnInput.addEventListener("input", function () {
                    if (!currentEditingCategory) {
                        const generatedKey = generateId(this.value);
                        keyInput.value = generatedKey;

                        // Check for duplicates
                        const errorDiv =
                            document.getElementById("category-key-error");
                        if (config.categories[generatedKey]) {
                            errorDiv.textContent =
                                "This key already exists";
                            keyInput.classList.add("error");
                        } else {
                            errorDiv.textContent = "";
                            keyInput.classList.remove("error");
                        }
                    }
                });
            }
        }

        // Emoji picker functionality (simplified)
        function showEmojiPicker(inputId) {
            const input = document.getElementById(inputId);
            const emojis = [
                "",
                "",
                "",
                "",
                "",
                "",
                "",
                "",
                "",
                "",
                "",
                "",
                "",
                "",
                "",
                "",
                "",
                "",
            ];

            const picker = document.createElement("div");
            picker.className = "emoji-picker";
            picker.style.cssText = `
                position: absolute;
                background: white;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                padding: 10px;
                display: grid;
                grid-template-columns: repeat(6, 1fr);
                gap: 5px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                z-index: 1050;
            `;

            emojis.forEach((emoji) => {
                const btn = document.createElement("button");
                btn.type = "button";
                btn.textContent = emoji;
                btn.style.cssText =
                    "border: none; background: none; font-size: 1.5rem; cursor: pointer; padding: 5px; border-radius: 4px;";
                btn.onmouseover = () => (btn.style.background = "#f8f9fa");
                btn.onmouseout = () => (btn.style.background = "none");
                btn.onclick = () => {
                    input.value = emoji;
                    picker.remove();
                };
                picker.appendChild(btn);
            });

            // Position picker near the input
            const rect = input.getBoundingClientRect();
            picker.style.top = `${rect.bottom + window.scrollY + 5}px`;
            picker.style.left = `${rect.left + window.scrollX}px`;

            document.body.appendChild(picker);

            // Close on click outside
            setTimeout(() => {
                document.addEventListener(
                    "click",
                    function closeEmojiPicker(e) {
                        if (
                            !picker.contains(e.target) &&
                            e.target !== input
                        ) {
                            picker.remove();
                            document.removeEventListener(
                                "click",
                                closeEmojiPicker,
                            );
                        }
                    },
                );
            }, 100);
        }

        // Additional CSS for category management
        const categoryStyles = `
            .category-item {
                transition: all 0.3s ease;
            }

            .category-item:hover {
                transform: translateY(-2px);
            }

            .category-stats {
                padding: 1rem;
                background: #f8f9fa;
                border-radius: 0 0 10px 10px;
                margin: -1.5rem -1.5rem 0 -1.5rem;
                margin-top: 1rem;
            }

            .stat-item {
                text-align: center;
            }

            .stat-label {
                display: block;
                font-size: 0.8rem;
                color: #666;
                text-transform: uppercase;
                margin-bottom: 0.25rem;
            }

            .stat-value {
                display: block;
                font-size: 1.2rem;
                font-weight: 600;
                color: #28a745;
            }

            .dropdown {
                position: relative;
            }

            .dropdown-menu {
                display: none;
                position: absolute;
                top: 100%;
                right: 0;
                background: white;
                border: 1px solid #e9ecef;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                z-index: 1000;
                min-width: 150px;
            }

            .dropdown-item {
                display: block;
                width: 100%;
                padding: 0.75rem 1rem;
                border: none;
                background: none;
                text-align: left;
                cursor: pointer;
                font-size: 0.9rem;
                transition: background 0.2s ease;
            }

            .dropdown-item:hover {
                background: #f8f9fa;
            }

            .dropdown-item.text-danger {
                color: #dc3545;
            }

            .dropdown-item.text-danger:hover {
                background: #f8d7da;
            }

            .emoji-picker {
                max-width: 240px;
            }
        `;

        // Add styles to document
        const styleSheet = document.createElement("style");
        styleSheet.textContent = categoryStyles;
        document.head.appendChild(styleSheet);

        // Setup category key generation when modal is shown
        document.addEventListener("DOMContentLoaded", function () {
            setupCategoryKeyGeneration();
        });

        // Product Management Functions
        function renderProducts() {
            const productsList = document.getElementById("products-list");
            const productsEmpty = document.getElementById("products-empty");

            if (!productsList) return;

            const allProducts = getAllProducts();
            const filteredProducts = filterProductsList(allProducts);

            if (filteredProducts.length === 0) {
                productsList.style.display = "none";
                productsEmpty.classList.remove("d-none");
                return;
            }

            productsList.style.display = "grid";
            productsEmpty.classList.add("d-none");

            productsList.innerHTML = filteredProducts
                .map(({ product, category, categoryKey }) => {
                    const hasOffer =
                        product.offer &&
                        product.offer.validUntil &&
                        new Date(product.offer.validUntil) > new Date();
                    const finalPrice = hasOffer
                        ? calculateOfferPrice(product.price, product.offer)
                        : product.price;

                    return `
                    <div class="card product-card" data-id="${product.id}" data-category="${categoryKey}">
                        ${product.tags && product.tags.includes("new-arrival") ? '<div class="product-badge badge badge-info">New</div>' : ""}
                        ${product.isBudgetPick ? '<div class="product-badge badge badge-success" style="top: 35px;">Budget</div>' : ""}
                        ${product.isCombo ? '<div class="product-badge badge badge-warning" style="top: 60px;">Combo</div>' : ""}

                        <div class="product-actions">
                            <button class="btn btn-sm btn-outline" onclick="editProduct('${categoryKey}', '${product.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct('${categoryKey}', '${product.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>

                        <div class="product-image">
                            ${product.images && product.images.length > 0
                            ? `<img src="${product.images[0]}" alt="${product.name?.en || "Product"}" onerror="this.style.display='none'">`
                            : `<div class="product-icon">${product.icon || ""}</div>`
                        }
                        </div>

                        <div class="product-name">${product.name?.en || "Unnamed Product"}</div>
                        <div class="product-unit text-muted">${product.name?.ta || ""}</div>

                        <div class="product-price">
                            ${hasOffer
                            ? `<span class="offer-price">${formatPrice(finalPrice)}</span>
                                 <span class="original-price text-muted" style="text-decoration: line-through; font-size: 0.9rem; margin-left: 0.5rem;">${formatPrice(product.price)}</span>`
                            : formatPrice(product.price)
                        }
                            <span class="unit-text">/${product.unitValue || 1} ${product.unit}</span>
                        </div>

                        <div class="product-stats">
                            <div class="product-stat">
                                <span class="product-stat-label">Status</span>
                                <span class="product-stat-value ${product.available ? "text-success" : "text-danger"}">
                                    ${product.available ? "Available" : "Unavailable"}
                                </span>
                            </div>
                            <div class="product-stat">
                                <span class="product-stat-label">Category</span>
                                <span class="product-stat-value">${category?.name?.en || "Uncategorized"}</span>
                            </div>
                            <div class="product-stat">
                                <span class="product-stat-label">Images</span>
                                <span class="product-stat-value">${(product.images || []).length}</span>
                            </div>
                        </div>
                    </div>
                `;
                })
                .join("");
        }

        function getAllProducts() {
            const products = [];
            Object.entries(config.products || {}).forEach(
                ([categoryKey, categoryProducts]) => {
                    const category = config.categories[categoryKey];
                    (categoryProducts || []).forEach((product) => {
                        if (product) {
                            products.push({
                                product,
                                category,
                                categoryKey,
                            });
                        }
                    });
                },
            );
            return products;
        }

        function filterProductsList(products) {
            const searchTerm =
                document
                    .getElementById("product-search")
                    ?.value.toLowerCase() || "";
            const categoryFilter =
                document.getElementById("category-filter")?.value || "";
            const statusFilter =
                document.getElementById("status-filter")?.value || "";

            return products.filter(({ product, categoryKey }) => {
                // Search filter
                const matchesSearch =
                    !searchTerm ||
                    product.name?.en?.toLowerCase().includes(searchTerm) ||
                    product.name?.ta?.toLowerCase().includes(searchTerm) ||
                    product.id?.toLowerCase().includes(searchTerm);

                // Category filter
                const matchesCategory =
                    !categoryFilter || categoryKey === categoryFilter;

                // Status filter
                const matchesStatus =
                    !statusFilter ||
                    (statusFilter === "available" && product.available) ||
                    (statusFilter === "unavailable" && !product.available);

                return matchesSearch && matchesCategory && matchesStatus;
            });
        }

        function filterProducts() {
            renderProducts();
        }

        function showProductModal(categoryKey = null, productId = null) {
            currentEditingProduct = productId
                ? { categoryKey, productId }
                : null;
            const modal = document.getElementById("product-modal");
            const title = document.getElementById("product-modal-title");
            const form = document.getElementById("product-form");

            // Populate category options
            populateProductCategoryOptions();
            populateComboProductOptions();

            if (productId && categoryKey) {
                title.textContent = "Edit Product";
                const product = findProduct(categoryKey, productId);
                if (product) {
                    populateProductForm(product, categoryKey);
                }
            } else {
                title.textContent = "Add Product";
                form.reset();
                // Set default category if provided
                if (categoryKey) {
                    document.getElementById(
                        "product-category-select",
                    ).value = categoryKey;
                }
                // Enable auto-generation for new products
                setupProductIdGeneration();
            }

            modal.classList.add("show");
        }

        function hideProductModal() {
            document
                .getElementById("product-modal")
                .classList.remove("show");
            currentEditingProduct = null;
        }

        function populateProductCategoryOptions() {
            const select = document.getElementById(
                "product-category-select",
            );
            if (!select) return;

            const currentValue = select.value;
            select.innerHTML = '<option value="">Select Category</option>';

            Object.entries(config.categories || {}).forEach(
                ([key, category]) => {
                    const option = document.createElement("option");
                    option.value = key;
                    option.textContent = getCategoryName(category);
                    select.appendChild(option);
                },
            );

            select.value = currentValue;
        }

        function populateComboProductOptions() {
            const selects = document.querySelectorAll(
                ".combo-product-select",
            );
            const allProducts = getAllProducts();

            selects.forEach((select) => {
                const currentValue = select.value;
                select.innerHTML =
                    '<option value="">Select Product</option>';

                allProducts.forEach(
                    ({ product, category, categoryKey }) => {
                        const option = document.createElement("option");
                        option.value = `${categoryKey}:${product.id}`;
                        option.textContent = `${getProductName(product)} (${getCategoryName(category)})`;
                        select.appendChild(option);
                    },
                );

                select.value = currentValue;
            });
        }

        function populateProductForm(product, categoryKey) {
            // Basic information
            document.getElementById("product-id").value = product.id;
            document.getElementById("product-id-input").value = product.id;
            document.getElementById("product-category").value = categoryKey;
            document.getElementById("product-category-select").value =
                categoryKey;
            document.getElementById("product-name-en").value =
                product.name?.en || "";
            document.getElementById("product-name-ta").value =
                product.name?.ta || "";
            document.getElementById("product-price").value =
                product.price || "";
            document.getElementById("product-unit-value").value =
                product.unitValue || "1";
            document.getElementById("product-display-unit-value").value =
                product.displayUnitValue || "";
            document.getElementById("product-display-amount").value =
                product.displayAmount || "";
            document.getElementById("product-display-unit").value =
                product.displayUnit || "";
            if (product.displayUnit === "custom") {
                document.getElementById("custom-display-unit-input").value =
                    product.displayUnit;
            }

            // Trigger calculation after loading values
            setTimeout(() => calculateDisplayAmount(), 100);
            document.getElementById("product-unit").value =
                product.unit || "Kg";
            document.getElementById("product-icon").value =
                product.icon || "";
            document.getElementById("product-available").checked =
                product.available !== false;

            // Disable ID editing for existing products
            document.getElementById("product-id-input").disabled = true;

            // Images
            populateImageInputs(product.images || []);

            // Tags
            document.getElementById("tag-new-arrival").checked =
                product.tags?.includes("new-arrival") || false;
            document.getElementById("tag-combo").checked =
                product.tags?.includes("combo") || false;

            // Budget pick
            document.getElementById("product-budget-pick").checked =
                product.isBudgetPick || false;
            if (product.isBudgetPick) {
                toggleBudgetOptions();
                populateBudgetOptions(product.budgetOptions || []);
            }

            // Easy Pick
            const hasEasyPick = product.easyPick?.enabled || product.tags?.includes("easy-pick");
            document.getElementById("product-easy-pick").checked = hasEasyPick || false;
            if (hasEasyPick) {
                toggleEasyPickOptions();
                if (product.easyPick?.presets) {
                    populateEasyPickPresets(product.easyPick.presets);
                }
            }

            // Combo options
            document.getElementById("product-is-combo").checked =
                product.isCombo || false;
            if (product.isCombo) {
                toggleComboBuilder();
                document.getElementById("combo-minimum").value =
                    product.comboMinimum || "";
            }

            // Special offers
            if (product.offer) {
                document.getElementById("product-has-offer").checked = true;
                toggleOfferSection();
                document.getElementById("offer-type").value =
                    product.offer.type || "discount";
                document.getElementById("offer-value").value =
                    product.offer.value || "";
                document.getElementById("offer-label-en").value =
                    product.offer.label?.en || "";
                document.getElementById("offer-label-ta").value =
                    product.offer.label?.ta || "";
                document.getElementById("offer-valid-from").value =
                    product.offer.validFrom || "";
                document.getElementById("offer-valid-until").value =
                    product.offer.validUntil || "";
            }

            // Combo products
            if (product.combo && product.combo.length > 0) {
                document.getElementById("product-is-combo").checked = true;
                toggleComboBuilder();
                populateComboItems(product.combo);
            }
        }

        function saveProduct(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const categoryKey = formData.get("categorySelect");
            const productId =
                currentEditingProduct?.productId ||
                generateId(formData.get("nameEn"));

            // Validate required fields
            if (!categoryKey) {
                showToast("Please select a category", "error");
                return;
            }

            // Check for duplicate IDs (except when editing the same product)
            if (!currentEditingProduct && findProductGlobally(productId)) {
                showToast("Product ID already exists", "error");
                return;
            }

            // Build product data
            const productData = {
                id: productId,
                name: {
                    en: formData.get("nameEn").trim(),
                    ta: formData.get("nameTa").trim(),
                },
                price: parseFloat(formData.get("price")) || 0,
                unitValue: parseFloat(formData.get("unitValue")) || 1,
                displayUnitValue:
                    parseFloat(formData.get("displayUnitValue")) || null,
                displayAmount:
                    parseFloat(formData.get("displayAmount")) || null,
                displayUnit:
                    formData.get("displayUnit") === "custom"
                        ? formData.get("customDisplayUnit")
                        : formData.get("displayUnit"),
                unit: formData.get("unit") || "Kg",
                icon: formData.get("icon").trim() || "",
                images: Array.from(formData.getAll("images[]")).filter(
                    (url) => url.trim(),
                ),
                available: formData.has("available"),
                tags: Array.from(formData.getAll("tags[]")),
                isBudgetPick: formData.has("isBudgetPick"),
                budgetOptions: collectBudgetOptions(),
                isCombo: formData.has("isCombo"),
                comboMinimum: formData.has("isCombo")
                    ? parseFloat(formData.get("comboMinimum")) || 0
                    : 0,
            };

            // Validate required fields
            if (!productData.name.en) {
                showToast("English name is required", "error");
                return;
            }

            if (!productData.name.ta) {
                showToast("Tamil name is required", "error");
                return;
            }

            if (productData.price <= 0) {
                showToast("Price must be greater than 0", "error");
                return;
            }

            // Add special offer if configured
            if (formData.has("hasOffer")) {
                const offerType = formData.get("offerType");
                const offerValue = parseFloat(formData.get("offerValue"));

                if (offerValue > 0) {
                    productData.offer = {
                        type: offerType,
                        value: offerValue,
                        label: {
                            en: formData.get("offerLabelEn")?.trim() || "",
                            ta: formData.get("offerLabelTa")?.trim() || "",
                        },
                        validFrom: formData.get("offerValidFrom") || "",
                        validUntil: formData.get("offerValidUntil") || "",
                    };
                }
            }

            // Add combo data if configured
            if (formData.has("isCombo")) {
                productData.combo = collectComboItems();
            }

            // Add Easy Pick data if configured
            if (formData.has("isEasyPick")) {
                const presets = collectEasyPickPresets();
                if (presets.length > 0) {
                    productData.easyPick = {
                        enabled: true,
                        unit: productData.unit,
                        presets: presets
                    };
                    // Add easy-pick tag for backward compatibility
                    if (!productData.tags.includes("easy-pick")) {
                        productData.tags.push("easy-pick");
                    }
                }
            } else {
                // Remove easy-pick tag if Easy Pick is disabled
                productData.tags = productData.tags.filter(tag => tag !== "easy-pick");
            }

            // Initialize categories and products if needed
            if (!config.categories) config.categories = {};
            if (!config.products) config.products = {};
            if (!config.products[categoryKey])
                config.products[categoryKey] = [];

            // Remove from old category if editing and category changed
            if (
                currentEditingProduct &&
                currentEditingProduct.categoryKey !== categoryKey
            ) {
                const oldProducts =
                    config.products[currentEditingProduct.categoryKey] ||
                    [];
                const oldIndex = oldProducts.findIndex(
                    (p) => p.id === productId,
                );
                if (oldIndex >= 0) {
                    oldProducts.splice(oldIndex, 1);
                }
            }

            // Add or update product
            const products = config.products[categoryKey];
            const existingIndex = products.findIndex(
                (p) => p && p.id === productId,
            );

            if (existingIndex >= 0) {
                products[existingIndex] = productData;
            } else {
                products.push(productData);
            }

            markChanges();
            renderProducts();
            hideProductModal();

            showToast(
                `Product ${currentEditingProduct ? "updated" : "created"} successfully`,
                "success",
            );
        }

        function editProduct(categoryKey, productId) {
            showProductModal(categoryKey, productId);
        }

        function deleteProduct(categoryKey, productId) {
            const product = findProduct(categoryKey, productId);
            if (!product) return;

            if (
                confirm(
                    `Are you sure you want to delete "${getProductName(product)}"?`,
                )
            ) {
                const products = config.products[categoryKey] || [];
                const index = products.findIndex(
                    (p) => p && p.id === productId,
                );

                if (index >= 0) {
                    products.splice(index, 1);
                    markChanges();
                    renderProducts();
                    showToast("Product deleted successfully", "success");
                }
            }
        }

        function findProduct(categoryKey, productId) {
            const products = config.products[categoryKey] || [];
            return products.find((p) => p && p.id === productId);
        }

        function findProductGlobally(productId) {
            for (const [categoryKey, products] of Object.entries(
                config.products || {},
            )) {
                const found = products.find((p) => p && p.id === productId);
                if (found) return { product: found, categoryKey };
            }
            return null;
        }

        function calculateOfferPrice(originalPrice, offer) {
            if (!offer || !offer.value) return originalPrice;

            if (offer.type === "discount") {
                return originalPrice * (1 - offer.value / 100);
            } else if (offer.type === "price") {
                return offer.value;
            }

            return originalPrice;
        }

        // Image management functions
        function addImageInput() {
            const container = document.getElementById(
                "product-images-container",
            );
            const imageGroup = document.createElement("div");
            imageGroup.className = "image-input-group";
            imageGroup.innerHTML = `
                <div class="d-flex gap-2">
                    <input type="url" class="form-control" name="images[]" placeholder="https://example.com/image.jpg">
                    <button type="button" class="btn btn-outline" onclick="previewImage(this)">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-danger" onclick="removeImageInput(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="image-preview mt-2"></div>
            `;
            container.appendChild(imageGroup);
        }

        function removeImageInput(button) {
            button.closest(".image-input-group").remove();
        }

        function previewImage(button) {
            const input =
                button.parentElement.querySelector('input[type="url"]');
            const preview =
                button.parentElement.parentElement.querySelector(
                    ".image-preview",
                );
            const url = input.value.trim();

            if (!url) {
                preview.innerHTML =
                    '<span class="text-muted">No image URL provided</span>';
                return;
            }

            preview.innerHTML =
                '<div class="loading">Loading image...</div>';
            preview.classList.add("loading");

            const img = new Image();
            img.onload = function () {
                preview.classList.remove("loading");
                preview.innerHTML = `<img src="${url}" alt="Product image">`;
            };
            img.onerror = function () {
                preview.classList.remove("loading");
                preview.innerHTML =
                    '<span class="text-danger">Failed to load image</span>';
            };
            img.src = url;
        }

        function populateImageInputs(images) {
            const container = document.getElementById(
                "product-images-container",
            );
            container.innerHTML = "";

            if (images.length === 0) {
                addImageInput();
            } else {
                images.forEach((url) => {
                    const imageGroup = document.createElement("div");
                    imageGroup.className = "image-input-group";
                    imageGroup.innerHTML = `
                        <div class="d-flex gap-2">
                            <input type="url" class="form-control" name="images[]" value="${url}" placeholder="https://example.com/image.jpg">
                            <button type="button" class="btn btn-outline" onclick="previewImage(this)">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="btn btn-danger" onclick="removeImageInput(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="image-preview mt-2"><img src="${url}" alt="Product image"></div>
                    `;
                    container.appendChild(imageGroup);
                });
            }
        }

        // Budget options management
        function toggleBudgetOptions() {
            const checkbox = document.getElementById("product-budget-pick");
            const container = document.getElementById(
                "budget-options-container",
            );

            if (checkbox.checked) {
                container.classList.remove("d-none");
            } else {
                container.classList.add("d-none");
            }
        }

        function addBudgetOption(button) {
            const input = button.parentElement.querySelector("input");
            const value = parseFloat(input.value);

            if (!value || value <= 0) {
                showToast("Please enter a valid price", "error");
                return;
            }

            const list = document.getElementById("budget-options-list");
            const option = document.createElement("div");
            option.className = "budget-option-item";
            option.innerHTML = `
                <span>${formatPrice(value)}</span>
                <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            option.dataset.value = value;

            list.appendChild(option);
            input.value = "";
        }

        function populateBudgetOptions(options) {
            const list = document.getElementById("budget-options-list");
            list.innerHTML = "";

            options.forEach((value) => {
                const option = document.createElement("div");
                option.className = "budget-option-item";
                option.innerHTML = `
                    <span>${formatPrice(value)}</span>
                    <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                option.dataset.value = value;
                list.appendChild(option);
            });
        }

        function collectBudgetOptions() {
            const items = document.querySelectorAll(
                "#budget-options-list .budget-option-item",
            );
            return Array.from(items)
                .map((item) => parseFloat(item.dataset.value))
                .sort((a, b) => a - b);
        }

        // Easy Pick options management
        function toggleEasyPickOptions() {
            const checkbox = document.getElementById("product-easy-pick");
            const container = document.getElementById("easy-pick-options-container");

            if (checkbox.checked) {
                container.classList.remove("d-none");
            } else {
                container.classList.add("d-none");
            }
        }

        function addEasyPickPreset() {
            const valueInput = document.getElementById("easy-pick-preset-value");
            const labelInput = document.getElementById("easy-pick-preset-label");
            const value = parseFloat(valueInput.value);
            const label = labelInput.value.trim();

            if (!value || value <= 0) {
                showToast("Please enter a valid quantity value", "error");
                return;
            }

            if (!label) {
                showToast("Please enter a label for the preset", "error");
                return;
            }

            const list = document.getElementById("easy-pick-presets-list");
            const preset = document.createElement("div");
            preset.className = "budget-option-item";
            preset.innerHTML = `
                    <span><strong>${value}</strong> - ${label}</span>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeEasyPickPreset(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            preset.dataset.value = value;
            preset.dataset.label = label;

            list.appendChild(preset);
            valueInput.value = "";
            labelInput.value = "";
        }

        function removeEasyPickPreset(button) {
            button.parentElement.remove();
        }

        function populateEasyPickPresets(presets) {
            const list = document.getElementById("easy-pick-presets-list");
            list.innerHTML = "";

            if (!presets || presets.length === 0) return;

            presets.forEach((preset) => {
                const item = document.createElement("div");
                item.className = "budget-option-item";
                item.innerHTML = `
                        <span><strong>${preset.value}</strong> - ${preset.label}</span>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeEasyPickPreset(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                item.dataset.value = preset.value;
                item.dataset.label = preset.label;
                list.appendChild(item);
            });
        }

        function collectEasyPickPresets() {
            const items = document.querySelectorAll("#easy-pick-presets-list .budget-option-item");
            return Array.from(items).map((item) => ({
                value: parseFloat(item.dataset.value),
                label: item.dataset.label
            }));
        }

        // Special offers management
        function toggleOfferSection() {
            const checkbox = document.getElementById("product-has-offer");
            const section = document.getElementById("offer-section");

            if (checkbox.checked) {
                section.classList.remove("d-none");
            } else {
                section.classList.add("d-none");
            }
        }

        // Combo builder management
        function toggleComboBuilder() {
            const checkbox = document.getElementById("product-is-combo");
            const section = document.getElementById(
                "combo-builder-section",
            );

            if (checkbox.checked) {
                section.classList.remove("d-none");
                populateComboProductOptions();
            } else {
                section.classList.add("d-none");
            }
        }

        function addComboItem() {
            const container = document.querySelector(
                ".combo-items-container",
            );
            const item = document.createElement("div");
            item.className = "combo-item";
            item.innerHTML = `
                <div class="grid grid-5">
                    <select class="form-control combo-product-select" name="comboProducts[]">
                        <option value="">Select Product</option>
                    </select>
                    <input type="text" class="form-control" name="comboUnits[]" placeholder="Unit (optional)">
                    <input type="number" class="form-control" name="comboUnitValues[]" placeholder="Unit Value (optional)" step="0.1" min="0">
                    <input type="number" class="form-control" name="comboQuantities[]" placeholder="Amount" min="1">
                    <button type="button" class="btn btn-danger" onclick="removeComboItem(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            container.appendChild(item);
            populateComboProductOptions();
        }

        function removeComboItem(button) {
            button.closest(".combo-item").remove();
        }

        function populateComboItems(combo) {
            const container = document.querySelector(
                ".combo-items-container",
            );
            container.innerHTML = "";

            combo.forEach((item) => {
                const comboItem = document.createElement("div");
                comboItem.className = "combo-item";
                comboItem.innerHTML = `
                    <div class="grid grid-5">
                        <select class="form-control combo-product-select" name="comboProducts[]">
                            <option value="">Select Product</option>
                        </select>
                        <input type="text" class="form-control" name="comboUnits[]" value="${item.unit || ""}" placeholder="Unit (optional)">
                        <input type="number" class="form-control" name="comboUnitValues[]" value="${item.unitValue || ""}" placeholder="Unit Value (optional)" step="0.1" min="0">
                        <input type="number" class="form-control" name="comboQuantities[]" value="${item.quantity}" placeholder="Amount" min="1">
                        <button type="button" class="btn btn-danger" onclick="removeComboItem(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;

                container.appendChild(comboItem);

                // Set the selected product
                const select = comboItem.querySelector("select");
                setTimeout(() => {
                    select.value = `${item.categoryKey}:${item.productId}`;
                }, 100);
            });

            populateComboProductOptions();
        }

        function collectComboItems() {
            const items = document.querySelectorAll(".combo-item");
            const combo = [];

            items.forEach((item) => {
                const select = item.querySelector("select");
                const unitInput = item.querySelector(
                    'input[name="comboUnits[]"]',
                );
                const unitValueInput = item.querySelector(
                    'input[name="comboUnitValues[]"]',
                );
                const quantityInput = item.querySelector(
                    'input[name="comboQuantities[]"]',
                );

                if (select.value && quantityInput.value) {
                    const [categoryKey, productId] =
                        select.value.split(":");
                    const comboItem = {
                        categoryKey,
                        productId,
                        quantity: parseInt(quantityInput.value),
                    };

                    // Add unit if provided
                    if (unitInput.value && unitInput.value.trim()) {
                        comboItem.unit = unitInput.value.trim();
                    }

                    // Add unitValue if provided
                    if (
                        unitValueInput.value &&
                        unitValueInput.value.trim()
                    ) {
                        comboItem.unitValue = parseFloat(
                            unitValueInput.value,
                        );
                    }

                    combo.push(comboItem);
                }
            });

            return combo;
        }

        // Auto-generate product ID from English name
        function setupProductIdGeneration() {
            const nameEnInput = document.getElementById("product-name-en");
            const idInput = document.getElementById("product-id-input");

            if (nameEnInput && idInput) {
                nameEnInput.addEventListener("input", function () {
                    if (!currentEditingProduct) {
                        const generatedId = generateId(this.value);
                        idInput.value = generatedId;

                        // Check for duplicates
                        const errorDiv =
                            document.getElementById("product-id-error");
                        if (findProductGlobally(generatedId)) {
                            errorDiv.textContent = "This ID already exists";
                            idInput.classList.add("error");
                        } else {
                            errorDiv.textContent = "";
                            idInput.classList.remove("error");
                        }
                    }
                });
            }
        }

        // Import/Export Functions
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== "application/json") {
                showToast("Please select a JSON file", "error");
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const content = e.target.result;
                    document.getElementById("import-text").value = content;
                    showToast("File loaded successfully", "success");
                } catch (error) {
                    showToast(
                        "Error reading file: " + error.message,
                        "error",
                    );
                }
            };
            reader.readAsText(file);
        }

        function importConfiguration() {
            const textInput = document.getElementById("import-text");
            const jsonText = textInput.value.trim();

            if (!jsonText) {
                showToast(
                    "Please provide JSON configuration to import",
                    "error",
                );
                return;
            }

            try {
                const importedConfig = JSON.parse(jsonText);

                // Validate the configuration structure
                if (!validateConfigurationSchema(importedConfig)) {
                    return; // Error already shown in validation
                }

                if (
                    confirm(
                        "This will replace your current configuration. Are you sure you want to continue?",
                    )
                ) {
                    config = importedConfig;

                    // Re-render everything
                    renderProducts();
                    renderCategories();
                    updateExportPreview();

                    markChanges();
                    showToast(
                        "Configuration imported successfully",
                        "success",
                    );

                    // Clear the import text
                    textInput.value = "";
                    document.getElementById("import-file").value = "";
                }
            } catch (error) {
                showToast("Invalid JSON format: " + error.message, "error");
            }
        }

        function validateConfigurationSchema(configData) {
            const errors = [];

            // Check required top-level properties
            if (!configData.categories) {
                errors.push('Missing "categories" object');
            }

            if (!configData.products) {
                errors.push('Missing "products" object');
            }

            if (!configData.localization) {
                errors.push('Missing "localization" object');
            }

            // Validate categories structure
            if (configData.categories) {
                Object.entries(configData.categories).forEach(
                    ([key, category]) => {
                        if (
                            !category.name ||
                            !category.name.en ||
                            !category.name.ta
                        ) {
                            errors.push(
                                `Category "${key}" missing bilingual names`,
                            );
                        }
                        if (!category.icon) {
                            errors.push(`Category "${key}" missing icon`);
                        }
                        if (typeof category.order !== "number") {
                            errors.push(
                                `Category "${key}" missing or invalid order`,
                            );
                        }
                        if (typeof category.visible !== "boolean") {
                            errors.push(
                                `Category "${key}" missing or invalid visibility`,
                            );
                        }
                    },
                );
            }

            // Validate products structure
            if (configData.products) {
                Object.entries(configData.products).forEach(
                    ([categoryKey, products]) => {
                        if (!Array.isArray(products)) {
                            errors.push(
                                `Products for category "${categoryKey}" must be an array`,
                            );
                            return;
                        }

                        products.forEach((product, index) => {
                            if (!product.id) {
                                errors.push(
                                    `Product at index ${index} in category "${categoryKey}" missing ID`,
                                );
                            }
                            if (
                                !product.name ||
                                !product.name.en ||
                                !product.name.ta
                            ) {
                                errors.push(
                                    `Product "${product.id || index}" in category "${categoryKey}" missing bilingual names`,
                                );
                            }
                            if (
                                typeof product.price !== "number" ||
                                product.price <= 0
                            ) {
                                errors.push(
                                    `Product "${product.id || index}" in category "${categoryKey}" missing or invalid price`,
                                );
                            }
                            if (!product.unit) {
                                errors.push(
                                    `Product "${product.id || index}" in category "${categoryKey}" missing unit`,
                                );
                            }
                            if (typeof product.available !== "boolean") {
                                errors.push(
                                    `Product "${product.id || index}" in category "${categoryKey}" missing or invalid availability`,
                                );
                            }
                        });
                    },
                );
            }

            // Validate localization structure
            if (configData.localization) {
                const requiredLanguages = ["en", "ta"];
                requiredLanguages.forEach((lang) => {
                    if (!configData.localization[lang]) {
                        errors.push(
                            `Missing localization for language "${lang}"`,
                        );
                    }
                });
            }

            if (errors.length > 0) {
                showToast(
                    "Configuration validation failed:\n" +
                    errors.join("\n"),
                    "error",
                );
                return false;
            }

            return true;
        }

        function exportJSON() {
            try {
                // Create a copy of config with pending price/stock changes applied
                const configWithChanges = JSON.parse(JSON.stringify(config));

                // Apply any pending price/stock changes to the export
                if (Object.keys(priceStockChanges).length > 0) {
                    Object.keys(priceStockChanges).forEach((key) => {
                        const [categoryKey, ...resetOfValues] = key.split("-");
                        const productId = resetOfValues.join("-");
                        const changes = priceStockChanges[key];

                        // Find and update the product in the config copy
                        if (configWithChanges.products && configWithChanges.products[categoryKey]) {
                            const products = configWithChanges.products[categoryKey];
                            const productIndex = products.findIndex(p => p && p.id === productId);

                            if (productIndex !== -1) {
                                if (changes.price !== undefined) {
                                    configWithChanges.products[categoryKey][productIndex].price = changes.price;
                                }
                                if (changes.available !== undefined) {
                                    configWithChanges.products[categoryKey][productIndex].available = changes.available;
                                }
                            }
                        }
                    });
                }

                const jsonString = JSON.stringify(configWithChanges, null, 2);
                const blob = new Blob([jsonString], {
                    type: "application/json",
                });
                const url = URL.createObjectURL(blob);

                const a = document.createElement("a");
                a.href = url;
                a.download = "vs-vegetables-config.json";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                const changeCount = Object.keys(priceStockChanges).length;
                const message = changeCount > 0
                    ? `Configuration exported successfully (including ${changeCount} pending price/stock changes)`
                    : "Configuration exported successfully";
                showToast(message, "success");
            } catch (error) {
                showToast("Export failed: " + error.message, "error");
            }
        }

        function copyJSON() {
            try {
                // Create a copy of config with pending price/stock changes applied
                const configWithChanges = JSON.parse(JSON.stringify(config));

                // Apply any pending price/stock changes to the copy
                if (Object.keys(priceStockChanges).length > 0) {
                    Object.keys(priceStockChanges).forEach((key) => {
                        const [categoryKey, ...resetOfValues] = key.split("-");
                        const productId = resetOfValues.join("-");
                        const changes = priceStockChanges[key];

                        // Find and update the product in the config copy
                        if (configWithChanges.products && configWithChanges.products[categoryKey]) {
                            const products = configWithChanges.products[categoryKey];
                            const productIndex = products.findIndex(p => p && p.id === productId);

                            if (productIndex !== -1) {
                                if (changes.price !== undefined) {
                                    configWithChanges.products[categoryKey][productIndex].price = changes.price;
                                }
                                if (changes.available !== undefined) {
                                    configWithChanges.products[categoryKey][productIndex].available = changes.available;
                                }
                            }
                        }
                    });
                }

                const jsonString = JSON.stringify(configWithChanges, null, 2);

                if (navigator.clipboard) {
                    navigator.clipboard
                        .writeText(jsonString)
                        .then(() => {
                            showToast(
                                "Configuration copied to clipboard",
                                "success",
                            );
                        })
                        .catch((err) => {
                            fallbackCopyTextToClipboard(jsonString);
                        });
                } else {
                    fallbackCopyTextToClipboard(jsonString);
                }
            } catch (error) {
                showToast("Copy failed: " + error.message, "error");
            }
        }

        function copyJS() {
            try {
                // Create a copy of config with pending price/stock changes applied
                const configWithChanges = JSON.parse(JSON.stringify(config));

                // Apply any pending price/stock changes to the copy
                if (Object.keys(priceStockChanges).length > 0) {
                    Object.keys(priceStockChanges).forEach((key) => {
                        const [categoryKey, ...resetOfValues] = key.split("-");
                        const productId = resetOfValues.join("-");
                        const changes = priceStockChanges[key];

                        // Find and update the product in the config copy
                        if (configWithChanges.products && configWithChanges.products[categoryKey]) {
                            const products = configWithChanges.products[categoryKey];
                            const productIndex = products.findIndex(p => p && p.id === productId);

                            if (productIndex !== -1) {
                                if (changes.price !== undefined) {
                                    configWithChanges.products[categoryKey][productIndex].price = changes.price;
                                }
                                if (changes.available !== undefined) {
                                    configWithChanges.products[categoryKey][productIndex].available = changes.available;
                                }
                            }
                        }
                    });
                }

                const jsString = `// Vs Vegetables Configuration
// Generated on ${new Date().toLocaleString()}
// Paste this into your HTML file script section

const config = ${JSON.stringify(configWithChanges, null, 2)};

// Update any references to use this config object`;

                if (navigator.clipboard) {
                    navigator.clipboard
                        .writeText(jsString)
                        .then(() => {
                            showToast(
                                "JavaScript configuration copied to clipboard",
                                "success",
                            );
                        })
                        .catch((err) => {
                            fallbackCopyTextToClipboard(jsString);
                        });
                } else {
                    fallbackCopyTextToClipboard(jsString);
                }
            } catch (error) {
                showToast("Copy failed: " + error.message, "error");
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand("copy");
                showToast("Configuration copied to clipboard", "success");
            } catch (err) {
                showToast(
                    "Unable to copy to clipboard. Please manually copy from the preview area.",
                    "warning",
                );
            }

            document.body.removeChild(textArea);
        }

        // Enhanced state management
        function setupAutoSave() {
            // Auto-save every 30 seconds
            setInterval(() => {
                if (hasUnsavedChanges) {
                    saveDraft();
                }
            }, 30000);

            // Also save when user becomes idle
            let lastActivity = Date.now();
            let isIdle = false;

            document.addEventListener(
                "mousemove",
                () => (lastActivity = Date.now()),
            );
            document.addEventListener(
                "keypress",
                () => (lastActivity = Date.now()),
            );
            document.addEventListener(
                "click",
                () => (lastActivity = Date.now()),
            );

            // Check for idle state every 10 seconds
            setInterval(() => {
                const now = Date.now();
                const wasIdle = isIdle;
                isIdle = now - lastActivity > 60000; // 1 minute idle

                if (!wasIdle && isIdle && hasUnsavedChanges) {
                    saveDraft();
                    showToast("Auto-saved due to inactivity", "info");
                }
            }, 10000);
        }

        function saveDraft() {
            try {
                const draftData = {
                    config: config,
                    timestamp: new Date().toISOString(),
                    version: "1.0",
                    metadata: {
                        totalCategories: Object.keys(
                            config.categories || {},
                        ).length,
                        totalProducts: Object.values(
                            config.products || {},
                        ).flat().length,
                        lastModified: new Date().toISOString(),
                    },
                };

                localStorage.setItem(
                    "vs-vegetables-admin-draft",
                    JSON.stringify(draftData),
                );
                localStorage.setItem(
                    "vs-vegetables-admin-draft-time",
                    draftData.timestamp,
                );

                document.getElementById("last-saved").textContent =
                    formatDate(new Date());
                hasUnsavedChanges = false;

                // Update changes status
                updateChangesStatus();

                showToast("Draft saved successfully", "success");
            } catch (error) {
                if (error.name === "QuotaExceededError") {
                    showToast(
                        "Storage quota exceeded. Please export your configuration and clear old drafts.",
                        "error",
                    );
                } else {
                    showToast(
                        "Failed to save draft: " + error.message,
                        "error",
                    );
                }
            }
        }

        function loadDraft() {
            try {
                const draftJson = localStorage.getItem(
                    "vs-vegetables-admin-draft",
                );
                if (!draftJson) {
                    showToast("No draft found", "warning");
                    return;
                }

                const draftData = JSON.parse(draftJson);

                // Validate draft structure
                if (!draftData.config || !draftData.timestamp) {
                    showToast("Invalid draft format", "error");
                    return;
                }

                if (
                    confirm(
                        "Loading draft will replace your current configuration. Continue?",
                    )
                ) {
                    config = draftData.config;

                    // Re-render everything
                    renderProducts();
                    renderCategories();
                    updateExportPreview();

                    const saveTime = draftData.timestamp;
                    document.getElementById("last-saved").textContent =
                        formatDate(new Date(saveTime));

                    // Display draft metadata if available
                    if (draftData.metadata) {
                        const meta = draftData.metadata;
                        showToast(
                            `Draft loaded: ${meta.totalCategories} categories, ${meta.totalProducts} products`,
                            "success",
                        );
                    } else {
                        showToast("Draft loaded successfully", "success");
                    }

                    hasUnsavedChanges = false;
                    updateChangesStatus();
                }
            } catch (error) {
                showToast(
                    "Failed to load draft: " + error.message,
                    "error",
                );
            }
        }

        function clearDraft() {
            if (
                confirm(
                    "Are you sure you want to clear the saved draft? This action cannot be undone.",
                )
            ) {
                try {
                    localStorage.removeItem("vs-vegetables-admin-draft");
                    localStorage.removeItem(
                        "vs-vegetables-admin-draft-time",
                    );
                    document.getElementById("last-saved").textContent =
                        "Never";
                    showToast("Draft cleared successfully", "success");
                } catch (error) {
                    showToast(
                        "Failed to clear draft: " + error.message,
                        "error",
                    );
                }
            }
        }

        // Enhanced preview functionality
        function updateExportPreview() {
            const preview = document.getElementById("export-preview");
            if (preview) {
                try {
                    // Create a copy of config with pending price/stock changes applied for preview
                    const configWithChanges = JSON.parse(JSON.stringify(config));

                    // Apply any pending price/stock changes to the preview
                    if (Object.keys(priceStockChanges).length > 0) {
                        Object.keys(priceStockChanges).forEach((key) => {
                            const [categoryKey, ...resetOfValues] = key.split("-");
                            const productId = resetOfValues.join("-");
                            const changes = priceStockChanges[key];

                            // Find and update the product in the config copy
                            if (configWithChanges.products && configWithChanges.products[categoryKey]) {
                                const products = configWithChanges.products[categoryKey];
                                const productIndex = products.findIndex(p => p && p.id === productId);

                                if (productIndex !== -1) {
                                    if (changes.price !== undefined) {
                                        configWithChanges.products[categoryKey][productIndex].price = changes.price;
                                    }
                                    if (changes.available !== undefined) {
                                        configWithChanges.products[categoryKey][productIndex].available = changes.available;
                                    }
                                }
                            }
                        });
                    }

                    const formattedJson = JSON.stringify(configWithChanges, null, 2);
                    preview.value = formattedJson;

                    // Update statistics
                    const stats = getConfigurationStats();
                    const statsText = `/* Configuration Statistics:
 * Categories: ${stats.categories}
 * Products: ${stats.products}
 * Total Images: ${stats.images}
 * Budget Products: ${stats.budgetProducts}
 * Products with Offers: ${stats.offersActive}
 * Last Updated: ${new Date().toLocaleString()}
 */\n\n${formattedJson}`;

                    preview.value = statsText;
                } catch (error) {
                    preview.value =
                        "Error generating preview: " + error.message;
                }
            }
        }

        function getConfigurationStats() {
            const stats = {
                categories: Object.keys(config.categories || {}).length,
                products: 0,
                images: 0,
                budgetProducts: 0,
                offersActive: 0,
            };

            Object.values(config.products || {}).forEach(
                (categoryProducts) => {
                    (categoryProducts || []).forEach((product) => {
                        if (product) {
                            stats.products++;
                            stats.images += (product.images || []).length;
                            if (product.isBudgetPick)
                                stats.budgetProducts++;
                            if (
                                product.offer &&
                                product.offer.validUntil &&
                                new Date(product.offer.validUntil) >
                                new Date()
                            ) {
                                stats.offersActive++;
                            }
                        }
                    });
                },
            );

            return stats;
        }

        // Data integrity checks
        function validateDataIntegrity() {
            const issues = [];

            // Check for orphaned products (products in categories that don't exist)
            Object.entries(config.products || {}).forEach(
                ([categoryKey, products]) => {
                    if (!config.categories[categoryKey]) {
                        issues.push(
                            `Category "${categoryKey}" has products but no category definition`,
                        );
                    }
                },
            );

            // Check for empty categories
            Object.keys(config.categories || {}).forEach((categoryKey) => {
                if (
                    !config.products[categoryKey] ||
                    config.products[categoryKey].length === 0
                ) {
                    issues.push(`Category "${categoryKey}" is empty`);
                }
            });

            // Check for duplicate product IDs
            const allProductIds = {};
            Object.entries(config.products || {}).forEach(
                ([categoryKey, products]) => {
                    (products || []).forEach((product) => {
                        if (product && product.id) {
                            if (allProductIds[product.id]) {
                                issues.push(
                                    `Duplicate product ID "${product.id}" found in categories "${allProductIds[product.id]}" and "${categoryKey}"`,
                                );
                            } else {
                                allProductIds[product.id] = categoryKey;
                            }
                        }
                    });
                },
            );

            // Check for missing translations
            Object.entries(config.categories || {}).forEach(
                ([key, category]) => {
                    if (!category.name?.en || !category.name?.ta) {
                        issues.push(
                            `Category "${key}" missing translations`,
                        );
                    }
                },
            );

            Object.entries(config.products || {}).forEach(
                ([categoryKey, products]) => {
                    (products || []).forEach((product) => {
                        if (
                            product &&
                            (!product.name?.en || !product.name?.ta)
                        ) {
                            issues.push(
                                `Product "${product.id || "unknown"}" in category "${categoryKey}" missing translations`,
                            );
                        }
                    });
                },
            );

            if (issues.length > 0) {
                console.warn("Data integrity issues found:", issues);
                return issues;
            }

            return [];
        }

        // Backup and restore functionality
        function createBackup() {
            const backup = {
                timestamp: new Date().toISOString(),
                version: "1.0",
                config: JSON.parse(JSON.stringify(config)), // Deep clone
                metadata: {
                    userAgent: navigator.userAgent,
                    url: window.location.href,
                    integrity: validateDataIntegrity(),
                },
            };

            const backupKey = `vs-vegetables-backup-${Date.now()}`;
            localStorage.setItem(backupKey, JSON.stringify(backup));

            // Cleanup old backups (keep only last 5)
            const backupKeys = Object.keys(localStorage).filter((key) =>
                key.startsWith("vs-vegetables-backup-"),
            );
            if (backupKeys.length > 5) {
                backupKeys
                    .sort()
                    .slice(0, -5)
                    .forEach((key) => {
                        localStorage.removeItem(key);
                    });
            }

            return backupKey;
        }

        // Enhanced form validation
        function validateProductForm(formData) {
            const errors = [];

            // Required field validation
            if (!formData.get("nameEn")?.trim()) {
                errors.push("English name is required");
            }

            if (!formData.get("nameTa")?.trim()) {
                errors.push("Tamil name is required");
            }

            const price = parseFloat(formData.get("price"));
            if (!price || price <= 0) {
                errors.push("Price must be a positive number");
            }

            const unitValue = parseFloat(formData.get("unitValue"));
            if (!unitValue || unitValue <= 0) {
                errors.push("Unit value must be a positive number");
            }

            // Combo validation
            if (formData.has("isCombo")) {
                const comboMinimum = parseFloat(
                    formData.get("comboMinimum"),
                );
                if (!comboMinimum || comboMinimum <= 0) {
                    errors.push(
                        "Combo minimum price must be a positive number",
                    );
                }
            }

            if (!formData.get("categorySelect")) {
                errors.push("Please select a category");
            }

            if (!formData.get("unit")) {
                errors.push("Please select a unit");
            }

            // Advanced validation
            const nameEn = formData.get("nameEn")?.trim();
            if (nameEn && nameEn.length < 2) {
                errors.push("English name must be at least 2 characters");
            }

            const nameTa = formData.get("nameTa")?.trim();
            if (nameTa && nameTa.length < 1) {
                errors.push("Tamil name must be at least 1 character");
            }

            if (price > 10000) {
                errors.push(
                    "Price seems too high (over 10,000). Please verify.",
                );
            }

            // Image URL validation
            const images = Array.from(formData.getAll("images[]")).filter(
                (url) => url.trim(),
            );
            images.forEach((url, index) => {
                if (!isValidURL(url)) {
                    errors.push(`Image URL ${index + 1} is not valid`);
                }
            });

            // Offer validation
            if (formData.has("hasOffer")) {
                const offerValue = parseFloat(formData.get("offerValue"));
                const offerType = formData.get("offerType");

                if (!offerValue || offerValue <= 0) {
                    errors.push("Offer value must be a positive number");
                } else if (offerType === "discount" && offerValue > 100) {
                    errors.push("Discount percentage cannot exceed 100%");
                } else if (offerType === "price" && offerValue >= price) {
                    errors.push(
                        "Offer price must be less than regular price",
                    );
                }

                const validFrom = formData.get("offerValidFrom");
                const validUntil = formData.get("offerValidUntil");

                if (
                    validFrom &&
                    validUntil &&
                    new Date(validFrom) >= new Date(validUntil)
                ) {
                    errors.push("Offer start date must be before end date");
                }
            }

            return errors;
        }

        function validateCategoryForm(formData) {
            const errors = [];

            // Required field validation
            if (!formData.get("nameEn")?.trim()) {
                errors.push("English name is required");
            }

            if (!formData.get("nameTa")?.trim()) {
                errors.push("Tamil name is required");
            }

            const order = parseInt(formData.get("order"));
            if (!order || order < 1) {
                errors.push("Display order must be a positive number");
            }

            // Advanced validation
            const nameEn = formData.get("nameEn")?.trim();
            if (nameEn && nameEn.length < 2) {
                errors.push("English name must be at least 2 characters");
            }

            const nameTa = formData.get("nameTa")?.trim();
            if (nameTa && nameTa.length < 1) {
                errors.push("Tamil name must be at least 1 character");
            }

            const icon = formData.get("icon")?.trim();
            if (icon && icon.length > 2) {
                errors.push("Icon should be a single emoji or character");
            }

            return errors;
        }

        function isValidURL(string) {
            try {
                const url = new URL(string);
                return (
                    url.protocol === "http:" || url.protocol === "https:"
                );
            } catch (_) {
                return false;
            }
        }

        function showFieldErrors(errors) {
            // Clear previous errors
            document.querySelectorAll(".form-error").forEach((error) => {
                error.textContent = "";
            });
            document
                .querySelectorAll(".form-control.error")
                .forEach((field) => {
                    field.classList.remove("error");
                });

            if (errors.length > 0) {
                showToast(
                    "Please fix the following errors:\n" +
                    errors.join("\n"),
                    "error",
                );

                // Highlight first error field
                const firstErrorField = findFieldByError(errors[0]);
                if (firstErrorField) {
                    firstErrorField.classList.add("error");
                    firstErrorField.focus();
                    firstErrorField.scrollIntoView({
                        behavior: "smooth",
                        block: "center",
                    });
                }
            }
        }

        function findFieldByError(errorMessage) {
            const errorMapping = {
                "English name": "product-name-en,category-name-en",
                "Tamil name": "product-name-ta,category-name-ta",
                Price: "product-price",
                category: "product-category-select",
                unit: "product-unit",
                icon: "product-icon,category-icon",
                "Display order": "category-order",
            };

            for (const [key, fieldIds] of Object.entries(errorMapping)) {
                if (
                    errorMessage.toLowerCase().includes(key.toLowerCase())
                ) {
                    for (const fieldId of fieldIds.split(",")) {
                        const field = document.getElementById(fieldId);
                        if (field) return field;
                    }
                }
            }

            return null;
        }

        // Real-time validation
        function setupRealTimeValidation() {
            // Product form validation
            const productForm = document.getElementById("product-form");
            if (productForm) {
                // Price validation
                const priceField = document.getElementById("product-price");
                if (priceField) {
                    priceField.addEventListener("input", function () {
                        const value = parseFloat(this.value);
                        const errorDiv =
                            this.parentElement.querySelector(
                                ".form-error",
                            ) || createErrorDiv(this);

                        if (this.value && (!value || value <= 0)) {
                            errorDiv.textContent =
                                "Price must be a positive number";
                            this.classList.add("error");
                        } else if (value > 10000) {
                            errorDiv.textContent =
                                "Price seems very high, please verify";
                            this.classList.add("error");
                        } else {
                            errorDiv.textContent = "";
                            this.classList.remove("error");
                        }
                    });
                }

                // Name validation
                ["product-name-en", "product-name-ta"].forEach((id) => {
                    const field = document.getElementById(id);
                    if (field) {
                        field.addEventListener("input", function () {
                            const errorDiv =
                                this.parentElement.querySelector(
                                    ".form-error",
                                ) || createErrorDiv(this);
                            const minLength = id.includes("-en") ? 2 : 1;

                            if (
                                this.value &&
                                this.value.trim().length < minLength
                            ) {
                                errorDiv.textContent = `Name must be at least ${minLength} character${minLength > 1 ? "s" : ""}`;
                                this.classList.add("error");
                            } else {
                                errorDiv.textContent = "";
                                this.classList.remove("error");
                            }
                        });
                    }
                });

                // URL validation for images
                productForm.addEventListener("input", function (e) {
                    if (
                        e.target.type === "url" &&
                        e.target.name === "images[]"
                    ) {
                        const errorDiv =
                            e.target.parentElement.parentElement.querySelector(
                                ".form-error",
                            ) || createErrorDiv(e.target.parentElement);

                        if (e.target.value && !isValidURL(e.target.value)) {
                            errorDiv.textContent =
                                "Please enter a valid URL (http:// or https://)";
                            e.target.classList.add("error");
                        } else {
                            errorDiv.textContent = "";
                            e.target.classList.remove("error");
                        }
                    }
                });
            }

            // Category form validation
            const categoryForm = document.getElementById("category-form");
            if (categoryForm) {
                ["category-name-en", "category-name-ta"].forEach((id) => {
                    const field = document.getElementById(id);
                    if (field) {
                        field.addEventListener("input", function () {
                            const errorDiv =
                                this.parentElement.querySelector(
                                    ".form-error",
                                ) || createErrorDiv(this);
                            const minLength = id.includes("-en") ? 2 : 1;

                            if (
                                this.value &&
                                this.value.trim().length < minLength
                            ) {
                                errorDiv.textContent = `Name must be at least ${minLength} character${minLength > 1 ? "s" : ""}`;
                                this.classList.add("error");
                            } else {
                                errorDiv.textContent = "";
                                this.classList.remove("error");
                            }
                        });
                    }
                });

                const orderField =
                    document.getElementById("category-order");
                if (orderField) {
                    orderField.addEventListener("input", function () {
                        const value = parseInt(this.value);
                        const errorDiv =
                            this.parentElement.querySelector(
                                ".form-error",
                            ) || createErrorDiv(this);

                        if (this.value && (!value || value < 1)) {
                            errorDiv.textContent =
                                "Order must be a positive number";
                            this.classList.add("error");
                        } else {
                            errorDiv.textContent = "";
                            this.classList.remove("error");
                        }
                    });
                }
            }
        }

        function createErrorDiv(parentElement) {
            const errorDiv = document.createElement("div");
            errorDiv.className = "form-error";
            parentElement.appendChild(errorDiv);
            return errorDiv;
        }

        // Enhanced save functions with validation
        function saveProduct(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const errors = validateProductForm(formData);

            if (errors.length > 0) {
                showFieldErrors(errors);
                return;
            }

            const categoryKey = formData.get("categorySelect");
            const productId =
                currentEditingProduct?.productId ||
                generateId(formData.get("nameEn"));

            // Check for duplicate IDs (except when editing the same product)
            if (!currentEditingProduct && findProductGlobally(productId)) {
                showToast("Product ID already exists", "error");
                return;
            }

            // Build product data
            const productData = {
                id: productId,
                name: {
                    en: formData.get("nameEn").trim(),
                    ta: formData.get("nameTa").trim(),
                },
                price: parseFloat(formData.get("price")) || 0,
                unitValue: parseFloat(formData.get("unitValue")) || 1,
                displayUnitValue:
                    parseFloat(formData.get("displayUnitValue")) || null,
                displayAmount:
                    parseFloat(formData.get("displayAmount")) || null,
                displayUnit:
                    formData.get("displayUnit") === "custom"
                        ? formData.get("customDisplayUnit")
                        : formData.get("displayUnit"),
                unit: formData.get("unit") || "Kg",
                icon: formData.get("icon").trim() || "",
                images: Array.from(formData.getAll("images[]")).filter(
                    (url) => url.trim(),
                ),
                available: formData.has("available"),
                tags: Array.from(formData.getAll("tags[]")),
                isBudgetPick: formData.has("isBudgetPick"),
                budgetOptions: collectBudgetOptions(),
                isCombo: formData.has("isCombo"),
                comboMinimum: formData.has("isCombo")
                    ? parseFloat(formData.get("comboMinimum")) || 0
                    : 0,
            };

            // Add special offer if configured
            if (formData.has("hasOffer")) {
                const offerType = formData.get("offerType");
                const offerValue = parseFloat(formData.get("offerValue"));

                if (offerValue > 0) {
                    productData.offer = {
                        type: offerType,
                        value: offerValue,
                        label: {
                            en: formData.get("offerLabelEn")?.trim() || "",
                            ta: formData.get("offerLabelTa")?.trim() || "",
                        },
                        validFrom: formData.get("offerValidFrom") || "",
                        validUntil: formData.get("offerValidUntil") || "",
                    };
                }
            }

            // Add combo data if configured
            if (formData.has("isCombo")) {
                productData.combo = collectComboItems();
            }

            // Add Easy Pick data if configured
            if (formData.has("isEasyPick")) {
                const presets = collectEasyPickPresets();
                if (presets.length > 0) {
                    productData.easyPick = {
                        enabled: true,
                        unit: productData.unit,
                        presets: presets
                    };
                    // Add easy-pick tag for backward compatibility
                    if (!productData.tags.includes("easy-pick")) {
                        productData.tags.push("easy-pick");
                    }
                }
            } else {
                // Remove easy-pick tag if Easy Pick is disabled
                productData.tags = productData.tags.filter(tag => tag !== "easy-pick");
            }

            // Initialize categories and products if needed
            if (!config.categories) config.categories = {};
            if (!config.products) config.products = {};
            if (!config.products[categoryKey])
                config.products[categoryKey] = [];

            // Remove from old category if editing and category changed
            if (
                currentEditingProduct &&
                currentEditingProduct.categoryKey !== categoryKey
            ) {
                const oldProducts =
                    config.products[currentEditingProduct.categoryKey] ||
                    [];
                const oldIndex = oldProducts.findIndex(
                    (p) => p.id === productId,
                );
                if (oldIndex >= 0) {
                    oldProducts.splice(oldIndex, 1);
                }
            }

            // Add or update product
            const products = config.products[categoryKey];
            const existingIndex = products.findIndex(
                (p) => p && p.id === productId,
            );

            if (existingIndex >= 0) {
                products[existingIndex] = productData;
            } else {
                products.push(productData);
            }

            markChanges();
            renderProducts();
            hideProductModal();

            showToast(
                `Product ${currentEditingProduct ? "updated" : "created"} successfully`,
                "success",
            );
        }

        function saveCategory(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const errors = validateCategoryForm(formData);

            if (errors.length > 0) {
                showFieldErrors(errors);
                return;
            }

            const key =
                currentEditingCategory ||
                generateId(formData.get("nameEn"));

            // Validate category key uniqueness for new categories
            if (!currentEditingCategory && config.categories[key]) {
                showToast("Category key already exists", "error");
                return;
            }

            const categoryData = {
                name: {
                    en: formData.get("nameEn").trim(),
                    ta: formData.get("nameTa").trim(),
                },
                icon: formData.get("icon").trim(),
                order: parseInt(formData.get("order")) || 1,
                visible: formData.has("visible"),
            };

            // Initialize categories if not exists
            if (!config.categories) {
                config.categories = {};
            }

            // Initialize products for this category if not exists
            if (!config.products) {
                config.products = {};
            }

            if (!config.products[key]) {
                config.products[key] = [];
            }

            config.categories[key] = categoryData;

            markChanges();
            renderCategories();
            hideCategoryModal();

            showToast(
                `Category ${currentEditingCategory ? "updated" : "created"} successfully`,
                "success",
            );
        }

        function updateExportPreview() {
            const preview = document.getElementById("export-preview");
            if (preview) {
                try {
                    // Create a copy of config with pending price/stock changes applied for preview
                    const configWithChanges = JSON.parse(JSON.stringify(config));

                    // Apply any pending price/stock changes to the preview
                    if (Object.keys(priceStockChanges).length > 0) {
                        Object.keys(priceStockChanges).forEach((key) => {
                            const [categoryKey, ...resetOfValues] = key.split("-");
                            const productId = resetOfValues.join("-");
                            const changes = priceStockChanges[key];

                            // Find and update the product in the config copy
                            if (configWithChanges.products && configWithChanges.products[categoryKey]) {
                                const products = configWithChanges.products[categoryKey];
                                const productIndex = products.findIndex(p => p && p.id === productId);

                                if (productIndex !== -1) {
                                    if (changes.price !== undefined) {
                                        configWithChanges.products[categoryKey][productIndex].price = changes.price;
                                    }
                                    if (changes.available !== undefined) {
                                        configWithChanges.products[categoryKey][productIndex].available = changes.available;
                                    }
                                }
                            }
                        });
                    }

                    const formattedJson = JSON.stringify(configWithChanges, null, 2);
                    preview.value = formattedJson;

                    // Update statistics
                    const stats = getConfigurationStats();
                    const statsText = `/* Configuration Statistics:
 * Categories: ${stats.categories}
 * Products: ${stats.products}
 * Total Images: ${stats.images}
 * Budget Products: ${stats.budgetProducts}
 * Products with Offers: ${stats.offersActive}
 * Last Updated: ${new Date().toLocaleString()}
 */

${formattedJson}`;

                    preview.value = statsText;
                } catch (error) {
                    preview.value =
                        "Error generating preview: " + error.message;
                }
            }
        }

        // ===========================================
        // PRICE & STOCK MANAGEMENT FUNCTIONALITY
        // ===========================================

        let priceStockChanges = {};
        let originalProductData = {};
        let filteredPriceStockProducts = [];
        let allPriceStockProducts = [];

        function renderPriceStockTab() {
            loadAllProducts();
            populatePriceStockFilters();
            renderPriceStockTable();
            updatePriceStockStats();
        }

        function loadAllProducts() {
            allPriceStockProducts = [];
            originalProductData = {};

            if (!config.products || !config.categories) return;

            Object.keys(config.products).forEach((categoryKey) => {
                const category = config.categories[categoryKey];
                const products = config.products[categoryKey] || [];

                products.forEach((product) => {
                    if (product && product.id) {
                        const productWithCategory = {
                            ...product,
                            categoryKey,
                            categoryName: category?.name?.en || categoryKey,
                        };
                        allPriceStockProducts.push(productWithCategory);

                        // Store original data for comparison
                        const key = `${categoryKey}-${product.id}`;
                        originalProductData[key] = {
                            price: product.price,
                            available: product.available,
                        };
                    }
                });
            });

            filteredPriceStockProducts = [...allPriceStockProducts];
        }

        function populatePriceStockFilters() {
            const categoryFilter = document.getElementById(
                "price-stock-category-filter",
            );
            if (!categoryFilter) return;

            // Clear existing options (except "All Categories")
            categoryFilter.innerHTML =
                '<option value="">All Categories</option>';

            if (config.categories) {
                Object.keys(config.categories).forEach((key) => {
                    const category = config.categories[key];
                    if (category && category.visible) {
                        const option = document.createElement("option");
                        option.value = key;
                        option.textContent = getCategoryName(category);
                        categoryFilter.appendChild(option);
                    }
                });
            }
        }

        function renderPriceStockTable() {
            const container = document.getElementById(
                "price-stock-table-container",
            );
            const emptyState = document.getElementById("price-stock-empty");

            if (!container) return;

            if (filteredPriceStockProducts.length === 0) {
                container.innerHTML = "";
                emptyState.classList.remove("d-none");
                return;
            }

            emptyState.classList.add("d-none");

            const tableHTML = `
                <div class="table-container">
                    <table class="price-stock-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="table-select-all" onchange="toggleTableSelectAll(this)">
                                </th>
                                <th style="width: 50px;">Icon</th>
                                <th class="product-name-cell">Product</th>
                                <th style="width: 120px;">Category</th>
                                <th style="width: 120px;">Price</th>
                                <th style="width: 80px;">Unit</th>
                                <th style="width: 150px;">Stock Status</th>
                                <th style="width: 100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredPriceStockProducts.map((product) => renderProductRow(product)).join("")}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHTML;

            // Update filtered count
            const countElement = document.getElementById("filtered-count");
            if (countElement) {
                countElement.textContent = `${filteredPriceStockProducts.length} product${filteredPriceStockProducts.length !== 1 ? "s" : ""}`;
            }
        }

        function renderProductRow(product) {
            const key = `${product.categoryKey}-${product.id}`;
            const isModified = priceStockChanges[key];
            const currentPrice = isModified
                ? priceStockChanges[key].price
                : product.price;
            const currentAvailable = isModified
                ? priceStockChanges[key].available
                : product.available;

            return `
                <tr class="${isModified ? "modified" : ""}" data-product-key="${key}">
                    <td>
                        <input type="checkbox" class="product-checkbox" data-product-key="${key}" onchange="updateBulkActionButtons()">
                    </td>
                    <td>
                        <span class="product-icon">${product.icon || ""}</span>
                    </td>
                    <td class="product-name-cell">
                        <div class="product-name-main">${product.name?.en || "Unnamed Product"}</div>
                        <div class="product-name-secondary">${product.name?.ta || ""}</div>
                        ${isModified ? '<span class="modified-indicator"></span>' : ""}
                    </td>
                    <td>
                        <span class="category-badge">${product.categoryName}</span>
                    </td>
                    <td class="price-edit-cell">
                        <input 
                            type="number" 
                            class="price-input ${isModified ? "modified" : ""}" 
                            value="${currentPrice || 0}" 
                            min="0" 
                            step="0.01"
                            data-product-key="${key}"
                            data-original="${product.price}"
                            onchange="updateProductPrice('${key}', this.value)"
                            onkeypress="if(event.key==='Enter') this.blur()"
                        >
                    </td>
                    <td>${product.unitValue || 1} ${product.unit || "Kg"}</td>
                    <td>
                        <label class="stock-toggle">
                            <input 
                                type="checkbox" 
                                ${currentAvailable ? "checked" : ""} 
                                data-product-key="${key}"
                                data-original="${product.available}"
                                onchange="updateProductAvailability('${key}', this.checked)"
                            >
                            <span class="stock-slider ${isModified ? "modified" : ""}"></span>
                        </label>
                        <span class="stock-status-text ${currentAvailable ? "available" : "unavailable"}">
                            ${currentAvailable ? "Available" : "Out of Stock"}
                        </span>
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-outline" onclick="resetProductChanges('${key}')" 
                                    ${!isModified ? "disabled" : ""} title="Reset changes">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="editProduct('${product.categoryKey}', '${product.id}')" title="Full edit">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function updateProductPrice(key, newPrice) {
            const price = parseFloat(newPrice) || 0;
            const [categoryKey, productId] = key.split("-");
            const originalData = originalProductData[key];

            if (!priceStockChanges[key]) {
                priceStockChanges[key] = {};
            }

            priceStockChanges[key].price = price;

            // Recalculate displayAmount for this product
            const products = config.products[categoryKey] || [];
            const product = products.find(p => p.id === productId);
            if (product) {
                const masterUnit = product.unit || "Kg";
                const masterUnitValue = parseFloat(product.unitValue) || 1;
                const displayUnit = product.displayUnit || "Grams";
                const displayUnitValue = parseFloat(product.displayUnitValue) || 0;

                if (price && displayUnitValue) {
                    let conversionFactor = 1;
                    if (masterUnit === "Kg" && displayUnit === "Grams") {
                        conversionFactor = 1000;
                    } else if (masterUnit === "Grams" && displayUnit === "Kg") {
                        conversionFactor = 0.001;
                    }
                    const convertedDisplayValue = displayUnitValue / conversionFactor;
                    const proportionalPrice = (price * convertedDisplayValue) / masterUnitValue;
                    priceStockChanges[key].displayAmount = parseFloat(proportionalPrice.toFixed(2));
                }
            }

            // Check if this is different from original
            const isActuallyModified =
                price !== originalData.price ||
                (priceStockChanges[key].available !== undefined &&
                    priceStockChanges[key].available !==
                    originalData.available);

            if (!isActuallyModified) {
                delete priceStockChanges[key];
            }

            updateChangeIndicators();
            updateRowModifiedState(key);
            updateBulkSaveButton();
        }

        function updateProductAvailability(key, isAvailable) {
            const [categoryKey, productId] = key.split("-");
            const originalData = originalProductData[key];

            if (!priceStockChanges[key]) {
                priceStockChanges[key] = {};
            }

            priceStockChanges[key].available = isAvailable;

            // Check if this is different from original
            const isActuallyModified =
                isAvailable !== originalData.available ||
                (priceStockChanges[key].price !== undefined &&
                    priceStockChanges[key].price !== originalData.price);

            if (!isActuallyModified) {
                delete priceStockChanges[key];
            }

            // Update status text
            const row = document.querySelector(
                `tr[data-product-key="${key}"]`,
            );
            if (row) {
                const statusText = row.querySelector(".stock-status-text");
                if (statusText) {
                    statusText.textContent = isAvailable
                        ? "Available"
                        : "Out of Stock";
                    statusText.className = `stock-status-text ${isAvailable ? "available" : "unavailable"}`;
                }
            }

            updateChangeIndicators();
            updateRowModifiedState(key);
            updateBulkSaveButton();
            updatePriceStockStats();
        }

        function updateRowModifiedState(key) {
            const row = document.querySelector(
                `tr[data-product-key="${key}"]`,
            );
            if (!row) return;

            const isModified = priceStockChanges[key];

            if (isModified) {
                row.classList.add("modified");

                // Update input states
                const priceInput = row.querySelector(".price-input");
                const stockSlider = row.querySelector(".stock-slider");
                const resetBtn = row.querySelector(".table-actions .btn");

                if (priceInput) priceInput.classList.add("modified");
                if (stockSlider) stockSlider.classList.add("modified");
                if (resetBtn) resetBtn.disabled = false;

                // Add modified indicator if not exists
                const nameCell = row.querySelector(".product-name-cell");
                if (
                    nameCell &&
                    !nameCell.querySelector(".modified-indicator")
                ) {
                    nameCell.insertAdjacentHTML(
                        "beforeend",
                        '<span class="modified-indicator"></span>',
                    );
                }
            } else {
                row.classList.remove("modified");

                // Update input states
                const priceInput = row.querySelector(".price-input");
                const stockSlider = row.querySelector(".stock-slider");
                const resetBtn = row.querySelector(".table-actions .btn");

                if (priceInput) priceInput.classList.remove("modified");
                if (stockSlider) stockSlider.classList.remove("modified");
                if (resetBtn) resetBtn.disabled = true;

                // Remove modified indicator
                const indicator = row.querySelector(".modified-indicator");
                if (indicator) indicator.remove();
            }
        }

        function updateChangeIndicators() {
            const hasChanges = Object.keys(priceStockChanges).length > 0;

            // Show/hide changes indicator
            let indicator = document.querySelector(".changes-indicator");
            if (hasChanges && !indicator) {
                indicator = document.createElement("div");
                indicator.className = "changes-indicator";
                indicator.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    ${Object.keys(priceStockChanges).length} unsaved changes
                `;
                document.body.appendChild(indicator);
                setTimeout(() => indicator.classList.add("show"), 100);
            } else if (hasChanges && indicator) {
                indicator.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    ${Object.keys(priceStockChanges).length} unsaved changes
                `;
            } else if (!hasChanges && indicator) {
                indicator.classList.remove("show");
                setTimeout(() => indicator.remove(), 300);
            }
        }

        function updateBulkSaveButton() {
            const saveBtn = document.getElementById("bulk-save-btn");
            if (saveBtn) {
                const hasChanges =
                    Object.keys(priceStockChanges).length > 0;
                saveBtn.disabled = !hasChanges;
                saveBtn.innerHTML = hasChanges
                    ? `<i class="fas fa-save"></i> Save ${Object.keys(priceStockChanges).length} Changes`
                    : '<i class="fas fa-save"></i> Save All Changes';
            }
        }

        function updatePriceStockStats() {
            const totalCount = allPriceStockProducts.length;
            let availableCount = 0;

            allPriceStockProducts.forEach((product) => {
                const key = `${product.categoryKey}-${product.id}`;
                const isAvailable =
                    priceStockChanges[key]?.available !== undefined
                        ? priceStockChanges[key].available
                        : product.available;

                if (isAvailable) availableCount++;
            });

            const outOfStockCount = totalCount - availableCount;

            // Update stat displays
            const totalElement = document.getElementById(
                "total-products-count",
            );
            const availableElement = document.getElementById(
                "available-products-count",
            );
            const outOfStockElement =
                document.getElementById("out-of-stock-count");

            if (totalElement) totalElement.textContent = totalCount;
            if (availableElement)
                availableElement.textContent = availableCount;
            if (outOfStockElement)
                outOfStockElement.textContent = outOfStockCount;
        }

        function filterPriceStockProducts() {
            const searchTerm =
                document
                    .getElementById("price-stock-search")
                    ?.value.toLowerCase() || "";
            const categoryFilter =
                document.getElementById("price-stock-category-filter")
                    ?.value || "";
            const statusFilter =
                document.getElementById("price-stock-status-filter")
                    ?.value || "";

            filteredPriceStockProducts = allPriceStockProducts.filter(
                (product) => {
                    const key = `${product.categoryKey}-${product.id}`;

                    // Search filter
                    const matchesSearch =
                        !searchTerm ||
                        product.name?.en
                            ?.toLowerCase()
                            .includes(searchTerm) ||
                        product.name?.ta
                            ?.toLowerCase()
                            .includes(searchTerm) ||
                        product.categoryName
                            .toLowerCase()
                            .includes(searchTerm);

                    // Category filter
                    const matchesCategory =
                        !categoryFilter ||
                        product.categoryKey === categoryFilter;

                    // Status filter
                    let matchesStatus = true;
                    if (statusFilter === "available") {
                        const isAvailable =
                            priceStockChanges[key]?.available !== undefined
                                ? priceStockChanges[key].available
                                : product.available;
                        matchesStatus = isAvailable;
                    } else if (statusFilter === "unavailable") {
                        const isAvailable =
                            priceStockChanges[key]?.available !== undefined
                                ? priceStockChanges[key].available
                                : product.available;
                        matchesStatus = !isAvailable;
                    } else if (statusFilter === "modified") {
                        matchesStatus = !!priceStockChanges[key];
                    }

                    return (
                        matchesSearch && matchesCategory && matchesStatus
                    );
                },
            );

            renderPriceStockTable();
        }

        function clearPriceStockFilters() {
            const searchInput =
                document.getElementById("price-stock-search");
            const categoryFilter = document.getElementById(
                "price-stock-category-filter",
            );
            const statusFilter = document.getElementById(
                "price-stock-status-filter",
            );

            if (searchInput) searchInput.value = "";
            if (categoryFilter) categoryFilter.value = "";
            if (statusFilter) statusFilter.value = "";

            filteredPriceStockProducts = [...allPriceStockProducts];
            renderPriceStockTable();
        }

        function resetProductChanges(key) {
            if (priceStockChanges[key]) {
                delete priceStockChanges[key];

                // Reset form values to original
                const originalData = originalProductData[key];
                const row = document.querySelector(
                    `tr[data-product-key="${key}"]`,
                );

                if (row && originalData) {
                    const priceInput = row.querySelector(".price-input");
                    const stockCheckbox = row.querySelector(
                        'input[type="checkbox"]',
                    );

                    if (priceInput) priceInput.value = originalData.price;
                    if (stockCheckbox)
                        stockCheckbox.checked = originalData.available;

                    // Trigger updates to refresh status text
                    updateProductAvailability(key, originalData.available);
                }

                updateRowModifiedState(key);
                updateChangeIndicators();
                updateBulkSaveButton();
                updatePriceStockStats();
            }
        }

        function resetAllChanges() {
            if (Object.keys(priceStockChanges).length === 0) {
                showToast("No changes to reset", "info");
                return;
            }

            if (
                confirm(
                    "Are you sure you want to reset all unsaved changes?",
                )
            ) {
                Object.keys(priceStockChanges).forEach((key) => {
                    resetProductChanges(key);
                });

                priceStockChanges = {};
                renderPriceStockTable();
                showToast("All changes have been reset", "success");
            }
        }

        function saveBulkChanges() {
            if (Object.keys(priceStockChanges).length === 0) {
                showToast("No changes to save", "info");
                return;
            }

            let savedCount = 0;
            const errors = [];

            Object.keys(priceStockChanges).forEach((key) => {
                const [categoryKey, ...resetOfValues] = key.split("-");
                productId = resetOfValues.join("-");
                const changes = priceStockChanges[key];

                try {
                    // Find and update the product

                    const products = config.products[categoryKey] || [];
                    const productIndex = products.findIndex(
                        (p) => p.id === productId,
                    );

                    console.log(productIndex);
                    if (productIndex >= 0) {
                        const product = products[productIndex];

                        if (changes.price !== undefined) {
                            product.price = changes.price;
                        }

                        if (changes.displayAmount !== undefined) {
                            product.displayAmount = changes.displayAmount;
                        }

                        if (changes.available !== undefined) {
                            product.available = changes.available;
                        }

                        // Update original data
                        originalProductData[key] = {
                            price: product.price,
                            available: product.available,
                        };

                        savedCount++;
                    } else {
                        errors.push(`Product ${productId} not found`);
                    }
                } catch (error) {
                    errors.push(
                        `Error updating ${productId}: ${error.message}`,
                    );
                }
            });

            if (errors.length > 0) {
                showToast(
                    `Saved ${savedCount} changes with ${errors.length} errors`,
                    "warning",
                );
                console.error("Save errors:", errors);
            } else {
                showToast(
                    `Successfully saved ${savedCount} changes`,
                    "success",
                );
            }

            // Clear changes and update displays
            priceStockChanges = {};
            markChanges();
            renderProducts(); // Update main product list

            // Reload all product data and refresh the table to show updated values
            loadAllProducts();
            filterPriceStockProducts(); // Apply current filters to updated data
            renderPriceStockTable();
            updatePriceStockStats(); // Update statistics
            updateChangeIndicators();
            updateBulkSaveButton();
        }

        // Bulk action functions
        function updateBulkActionButtons() {
            const checkboxes =
                document.querySelectorAll(".product-checkbox");
            const checkedCount = Array.from(checkboxes).filter(
                (cb) => cb.checked,
            ).length;

            const bulkButtons = [
                "bulk-available-btn",
                "bulk-unavailable-btn",
                "bulk-price-btn",
            ];
            bulkButtons.forEach((btnId) => {
                const btn = document.getElementById(btnId);
                if (btn) btn.disabled = checkedCount === 0;
            });

            // Update select all checkbox state
            const selectAllCheckbox = document.getElementById(
                "select-all-products",
            );
            const tableSelectAllCheckbox =
                document.getElementById("table-select-all");

            if (selectAllCheckbox && checkboxes.length > 0) {
                selectAllCheckbox.indeterminate =
                    checkedCount > 0 && checkedCount < checkboxes.length;
                selectAllCheckbox.checked =
                    checkedCount === checkboxes.length;
            }

            if (tableSelectAllCheckbox && checkboxes.length > 0) {
                tableSelectAllCheckbox.indeterminate =
                    checkedCount > 0 && checkedCount < checkboxes.length;
                tableSelectAllCheckbox.checked =
                    checkedCount === checkboxes.length;
            }
        }

        function toggleSelectAll(checkbox) {
            const productCheckboxes =
                document.querySelectorAll(".product-checkbox");
            productCheckboxes.forEach((cb) => {
                cb.checked = checkbox.checked;
            });
            updateBulkActionButtons();
        }

        function toggleTableSelectAll(checkbox) {
            toggleSelectAll(checkbox);

            // Sync with main select all checkbox
            const mainSelectAll = document.getElementById(
                "select-all-products",
            );
            if (mainSelectAll) {
                mainSelectAll.checked = checkbox.checked;
                mainSelectAll.indeterminate = false;
            }
        }

        function getSelectedProducts() {
            const checkboxes = document.querySelectorAll(
                ".product-checkbox:checked",
            );
            return Array.from(checkboxes).map(
                (cb) => cb.dataset.productKey,
            );
        }

        function bulkSetAvailable(isAvailable) {
            const selectedKeys = getSelectedProducts();

            if (selectedKeys.length === 0) {
                showToast("No products selected", "warning");
                return;
            }

            const action = isAvailable ? "available" : "out of stock";
            if (
                confirm(
                    `Set ${selectedKeys.length} selected products as ${action}?`,
                )
            ) {
                selectedKeys.forEach((key) => {
                    updateProductAvailability(key, isAvailable);

                    // Update checkbox in table
                    const checkbox = document.querySelector(
                        `input[type="checkbox"][data-product-key="${key}"]`,
                    );
                    if (checkbox) {
                        checkbox.checked = isAvailable;
                    }
                });

                showToast(
                    `Set ${selectedKeys.length} products as ${action}`,
                    "success",
                );
            }
        }

        function bulkUpdatePrice() {
            const selectedKeys = getSelectedProducts();
            const newPrice = parseFloat(
                document.getElementById("bulk-price-input")?.value,
            );

            if (selectedKeys.length === 0) {
                showToast("No products selected", "warning");
                return;
            }

            if (!newPrice || newPrice <= 0) {
                showToast("Please enter a valid price", "error");
                return;
            }

            if (
                confirm(
                    `Update price of ${selectedKeys.length} selected products to ${newPrice}?`,
                )
            ) {
                selectedKeys.forEach((key) => {
                    updateProductPrice(key, newPrice);

                    // Update input in table
                    const input = document.querySelector(
                        `input[data-product-key="${key}"]`,
                    );
                    if (input) {
                        input.value = newPrice;
                    }
                });

                // Clear bulk price input
                document.getElementById("bulk-price-input").value = "";

                showToast(
                    `Updated price for ${selectedKeys.length} products`,
                    "success",
                );
            }
        }

        // Event listeners for Price & Stock tab
        function initializePriceStockEventListeners() {
            // Search input
            const searchInput =
                document.getElementById("price-stock-search");
            if (searchInput) {
                searchInput.addEventListener(
                    "input",
                    filterPriceStockProducts,
                );
            }

            // Category filter
            const categoryFilter = document.getElementById(
                "price-stock-category-filter",
            );
            if (categoryFilter) {
                categoryFilter.addEventListener(
                    "change",
                    filterPriceStockProducts,
                );
            }

            // Status filter
            const statusFilter = document.getElementById(
                "price-stock-status-filter",
            );
            if (statusFilter) {
                statusFilter.addEventListener(
                    "change",
                    filterPriceStockProducts,
                );
            }

            // Bulk price input
            const bulkPriceInput =
                document.getElementById("bulk-price-input");
            if (bulkPriceInput) {
                bulkPriceInput.addEventListener("input", function () {
                    const bulkPriceBtn =
                        document.getElementById("bulk-price-btn");
                    if (bulkPriceBtn) {
                        const hasValue =
                            this.value && parseFloat(this.value) > 0;
                        const hasSelected =
                            getSelectedProducts().length > 0;
                        bulkPriceBtn.disabled = !hasValue || !hasSelected;
                    }
                });
            }
        }

        // ===== WhatsApp Price List Generator Functions =====

        // Main function called by the WhatsApp button
        function generateWhatsAppList() {
            populateWhatsAppCategoryFilters();
            showWhatsAppModal();
            regenerateWhatsAppPreview();
        }

        // Show/hide WhatsApp modal functions
        function showWhatsAppModal() {
            document.getElementById("whatsapp-modal").classList.add("show");
            document.body.style.overflow = "hidden"; // Prevent background scrolling
        }

        function hideWhatsAppModal() {
            document
                .getElementById("whatsapp-modal")
                .classList.remove("show");
            document.body.style.overflow = "auto";
        }

        // Populate category filter checkboxes
        function populateWhatsAppCategoryFilters() {
            const container = document.getElementById(
                "whatsapp-category-filters",
            );
            if (!container) return;

            // Get all categories sorted by order
            const categories = Object.entries(config.categories || {}).sort(
                ([, a], [, b]) => (a.order || 0) - (b.order || 0),
            );

            container.innerHTML = categories
                .map(([key, category]) => {
                    return `
                    <div class="d-flex align-center gap-1">
                        <input type="checkbox" id="category-${key}" value="${key}" 
                               onchange="regenerateWhatsAppPreview()" checked>
                        <label for="category-${key}" class="form-label" style="margin-bottom: 0;">
                            ${category.icon} ${category.name?.en || key}
                        </label>
                    </div>
                `;
                })
                .join("");
        }

        // Generate and update the WhatsApp preview
        function regenerateWhatsAppPreview() {
            const previewElement =
                document.getElementById("whatsapp-preview");
            if (!previewElement) return;

            try {
                const includeOutOfStock =
                    document.getElementById("include-out-of-stock")
                        ?.checked || false;
                const groupByCategory =
                    document.getElementById("group-by-category")?.checked ||
                    false;

                // Get selected categories
                const selectedCategories = Array.from(
                    document.querySelectorAll(
                        '#whatsapp-category-filters input[type="checkbox"]:checked',
                    ),
                ).map((cb) => cb.value);

                if (selectedCategories.length === 0) {
                    previewElement.textContent =
                        "Please select at least one category to include in the price list.";
                    updateWhatsAppStats(0, 0, 0);
                    return;
                }

                // Build the price list text
                let whatsappText = "*VS VEGETABLES*\n 8300813853\n\n";
                let productCount = 0;
                let categoryCount = 0;

                if (groupByCategory) {
                    // Group by category
                    const categories = Object.entries(
                        config.categories || {},
                    )
                        .filter(([key]) => selectedCategories.includes(key))
                        .sort(
                            ([, a], [, b]) =>
                                (a.order || 0) - (b.order || 0),
                        );

                    categories.forEach(([categoryKey, category]) => {
                        const products = (
                            config.products[categoryKey] || []
                        ).filter(
                            (product) =>
                                product &&
                                (includeOutOfStock || product.available),
                        );

                        if (products.length > 0) {
                            categoryCount++;
                            // Add category header
                            whatsappText += `*${category.name?.ta || category.name?.en || categoryKey}*\n`;

                            // Add products
                            products.forEach((product) => {
                                const tamilName =
                                    product.name?.ta ||
                                    product.name?.en ||
                                    product.id;
                                const englishName =
                                    product.name?.en ||
                                    product.name?.ta ||
                                    product.id;
                                const price = product.price || 0;
                                const unit = product.unit || "kg";
                                const displayUnitValue = product.displayUnitValue || (unit === "Kg" ? 0.25 : 1);
                                const displayAmount = product.displayAmount || Math.ceil(price * displayUnitValue);
                                const displayUnit = product.displayUnit || "Grams";

                                // Get checkbox states
                                const showMaster = document.getElementById("show-master-value")?.checked;
                                const showDisplay = document.getElementById("show-display-value")?.checked;

                                // Format bilingual name: "Tamil (English)" or just one name if same
                                const displayName =
                                    tamilName &&
                                        englishName &&
                                        tamilName !== englishName
                                        ? `${tamilName} (${englishName})`
                                        : tamilName;

                                // Build price string based on selection
                                let priceString = "";
                                const masterPart = `Rs ${price} per ${unit.toLowerCase()}`;
                                const unitDisplay = (displayUnit === "Grams" && displayUnitValue < 10) ? `${displayUnitValue * 1000}g` : (displayUnit === "Grams" ? `${displayUnitValue}g` : `${displayUnitValue} ${displayUnit}`);
                                const displayPart = `${unitDisplay} for ${displayAmount}`;

                                // Check for redundancy (if they represent the same quantity and price)
                                const isRedundant = (unit.toLowerCase() === displayUnit.toLowerCase() && parseFloat(displayUnitValue) === 1 && price === displayAmount) ||
                                    (unit.toLowerCase() === 'kg' && displayUnit === 'Grams' && parseFloat(displayUnitValue) === 1000 && price === displayAmount);

                                if (showMaster && showDisplay) {
                                    if (isRedundant) {
                                        priceString = `  ${masterPart}`;
                                    } else {
                                        priceString = `  ${masterPart} | ${displayPart}`;
                                    }
                                } else if (showDisplay) {
                                    priceString = `  ${displayPart}`;
                                } else {
                                    // Show master only (default)
                                    priceString = `  ${masterPart}`;
                                }

                                whatsappText += `${displayName}${priceString}\n`;
                                productCount++;

                            });
                            whatsappText += "\n"; // Extra line between categories
                        }
                    });
                } else {
                    // All products together
                    const allProducts = [];

                    selectedCategories.forEach((categoryKey) => {
                        const products = (
                            config.products[categoryKey] || []
                        )
                            .filter(
                                (product) =>
                                    product &&
                                    (includeOutOfStock ||
                                        product.available),
                            )
                            .map((product) => ({
                                ...product,
                                categoryKey,
                            }));
                        allProducts.push(...products);
                    });

                    // Sort products by Tamil name
                    allProducts.sort((a, b) => {
                        const nameA = a.name?.ta || a.name?.en || a.id;
                        const nameB = b.name?.ta || b.name?.en || b.id;
                        return nameA.localeCompare(nameB, "ta");
                    });

                    allProducts.forEach((product) => {
                        const tamilName =
                            product.name?.ta ||
                            product.name?.en ||
                            product.id;
                        const englishName =
                            product.name?.en ||
                            product.name?.ta ||
                            product.id;
                        const price = product.price || 0;
                        const unit = product.unit || "kg";
                        const displayUnitValue = product.displayUnitValue || (unit === "Kg" ? 0.25 : 1);
                        const displayAmount = product.displayAmount || Math.ceil(price * displayUnitValue);
                        const displayUnit = product.displayUnit || "Grams";

                        // Get checkbox states
                        const showMaster = document.getElementById("show-master-value")?.checked;
                        const showDisplay = document.getElementById("show-display-value")?.checked;

                        // Format bilingual name: "Tamil (English)" or just one name if same
                        const displayName =
                            tamilName &&
                                englishName &&
                                tamilName !== englishName
                                ? `${tamilName} (${englishName})`
                                : tamilName;

                        // Build price string based on selection
                        let priceString = "";
                        const masterPart = `Rs ${price} per ${unit.toLowerCase()}`;
                        const unitDisplay = (displayUnit === "Grams" && displayUnitValue < 10) ? `${displayUnitValue * 1000}g` : (displayUnit === "Grams" ? `${displayUnitValue}g` : `${displayUnitValue} ${displayUnit}`);
                        const displayPart = `${unitDisplay} for ${displayAmount}`;

                        // Check for redundancy (if they represent the same quantity and price)
                        const isRedundant = (unit.toLowerCase() === displayUnit.toLowerCase() && parseFloat(displayUnitValue) === 1 && price === displayAmount) ||
                            (unit.toLowerCase() === 'kg' && displayUnit === 'Grams' && parseFloat(displayUnitValue) === 1000 && price === displayAmount);

                        if (showMaster && showDisplay) {
                            if (isRedundant) {
                                priceString = `  ${masterPart}`;
                            } else {
                                priceString = `  ${masterPart} | ${displayPart}`;
                            }
                        } else if (showDisplay) {
                            priceString = `  ${displayPart}`;
                        } else {
                            // Show master only (default)
                            priceString = `  ${masterPart}`;
                        }

                        whatsappText += `${displayName}${priceString}\n`;
                        productCount++;

                    });

                    categoryCount = selectedCategories.length;
                }

                // Add footer with contact info (optional)
                whatsappText +=
                    "\nFor orders, call: \nFresh vegetables delivered daily! \n\n Visit: www.thevsv.in";

                // Update preview
                previewElement.textContent = whatsappText.trim();

                // Update statistics
                updateWhatsAppStats(
                    productCount,
                    categoryCount,
                    whatsappText.length,
                );
            } catch (error) {
                console.error("Error generating WhatsApp preview:", error);
                previewElement.textContent =
                    "Error generating preview. Please try again.";
                updateWhatsAppStats(0, 0, 0);
            }
        }

        // Update statistics display
        function updateWhatsAppStats(
            productCount,
            categoryCount,
            charCount,
        ) {
            const productCountEl = document.getElementById(
                "whatsapp-product-count",
            );
            const categoryCountEl = document.getElementById(
                "whatsapp-category-count",
            );
            const charCountEl = document.getElementById(
                "whatsapp-char-count",
            );

            if (productCountEl) productCountEl.textContent = productCount;
            if (categoryCountEl)
                categoryCountEl.textContent = categoryCount;
            if (charCountEl) charCountEl.textContent = charCount;
        }

        // Copy WhatsApp text to clipboard
        async function copyWhatsAppList() {
            const previewElement =
                document.getElementById("whatsapp-preview");
            const copyButton = document.getElementById("copy-whatsapp-btn");

            if (!previewElement || !previewElement.textContent) {
                showToast("No content to copy", "error");
                return;
            }

            const textToCopy = previewElement.textContent;

            // Update button state
            const originalText = copyButton.innerHTML;
            copyButton.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Copying...';
            copyButton.disabled = true;

            try {
                // Use the Clipboard API if available
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(textToCopy);
                } else {
                    // Fallback for older browsers
                    const textArea = document.createElement("textarea");
                    textArea.value = textToCopy;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-999999px";
                    textArea.style.top = "-999999px";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();

                    const successful = document.execCommand("copy");
                    document.body.removeChild(textArea);

                    if (!successful) {
                        throw new Error("Copy command was unsuccessful");
                    }
                }

                // Success feedback
                showToast(
                    "Price list copied to clipboard! Ready to paste in WhatsApp.",
                    "success",
                );

                // Update button to show success
                copyButton.innerHTML =
                    '<i class="fas fa-check"></i> Copied!';
                copyButton.classList.remove("btn-success");
                copyButton.classList.add("btn-primary");

                // Reset button after 3 seconds
                setTimeout(() => {
                    copyButton.innerHTML = originalText;
                    copyButton.classList.remove("btn-primary");
                    copyButton.classList.add("btn-success");
                    copyButton.disabled = false;
                }, 3000);

                // Optional: Close modal after successful copy
                setTimeout(() => {
                    hideWhatsAppModal();
                }, 2000);
            } catch (error) {
                console.error("Failed to copy text:", error);
                showToast(
                    "Failed to copy to clipboard. Please try again or copy manually.",
                    "error",
                );

                // Reset button
                copyButton.innerHTML = originalText;
                copyButton.disabled = false;
            }
        }

        // Close modal when clicking outside
        document.addEventListener("click", function (event) {
            const modal = document.getElementById("whatsapp-modal");
            if (event.target === modal) {
                hideWhatsAppModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener("keydown", function (event) {
            if (event.key === "Escape") {
                const modal = document.getElementById("whatsapp-modal");
                if (modal && modal.classList.contains("show")) {
                    hideWhatsAppModal();
                }
            }
        });

        // Custom Unit Toggle Functionality
        function toggleCustomUnit(selectElement) {
            const customInput =
                document.getElementById("custom-unit-input");
            if (selectElement.value === "custom") {
                customInput.style.display = "block";
                customInput.required = true;
                customInput.focus();
            } else {
                customInput.style.display = "none";
                customInput.required = false;
                customInput.value = "";
            }
        }

        function toggleCustomDisplayUnit(selectElement) {
            const customInput = document.getElementById(
                "custom-display-unit-input",
            );
            if (selectElement.value === "custom") {
                customInput.style.display = "block";
                customInput.focus();
            } else {
                customInput.style.display = "none";
                customInput.value = "";
            }
        }

        // Calculate display amount based on pricing logic
        function calculateDisplayAmount() {
            const price =
                parseFloat(
                    document.getElementById("product-price").value,
                ) || 0;
            const masterUnit =
                document.getElementById("product-unit").value;
            const masterUnitValue =
                parseFloat(
                    document.getElementById("product-unit-value").value,
                ) || 1;
            const displayUnit = document.getElementById(
                "product-display-unit",
            ).value;
            const displayUnitValue =
                parseFloat(
                    document.getElementById("product-display-unit-value")
                        .value,
                ) || 0;

            if (!price || !displayUnitValue) {
                document.getElementById("product-display-amount").value =
                    "";
                return;
            }

            // Handle unit conversion (kg to grams, etc.)
            let conversionFactor = 1;
            if (masterUnit === "Kg" && displayUnit === "Grams") {
                conversionFactor = 1000; // 1 kg = 1000 grams
            } else if (masterUnit === "Grams" && displayUnit === "Kg") {
                conversionFactor = 0.001; // 1 gram = 0.001 kg
            }

            // Convert display unit value to master unit for calculation
            const convertedDisplayValue =
                displayUnitValue / conversionFactor;

            // Calculate proportional price: (price * convertedDisplayValue) / masterUnitValue
            const proportionalPrice =
                (price * convertedDisplayValue) / masterUnitValue;

            // Use 2 decimal places for displayAmount
            const formattedPrice = parseFloat(proportionalPrice.toFixed(2));

            document.getElementById("product-display-amount").value =
                formattedPrice;
        }

        // ===========================================
        // GLOBAL PRODUCT ORDER MANAGEMENT FUNCTIONALITY
        // ===========================================

        let originalGlobalOrder = [];
        let currentGlobalOrder = [];

        // Initialize the product order tab
        function initializeProductOrderTab() {
            loadAllProductsForOrdering();
        }

        // Load ALL products from ALL categories for global ordering
        function loadAllProductsForOrdering() {
            if (!config.products || !config.categories) {
                showEmptyOrderState('No products or categories found');
                return;
            }

            // Flatten all products from all categories
            const allProducts = [];

            Object.keys(config.products).forEach(categoryKey => {
                const products = config.products[categoryKey] || [];
                const categoryInfo = config.categories[categoryKey];

                if (categoryInfo && categoryInfo.visible !== false) {
                    products.forEach(product => {
                        allProducts.push({
                            ...product,
                            categoryKey: categoryKey,
                            categoryName: categoryInfo.name?.en || categoryKey
                        });
                    });
                }
            });

            if (allProducts.length === 0) {
                showEmptyOrderState('No products found');
                return;
            }

            // Check if we have a saved global order
            if (config.globalProductOrder && Array.isArray(config.globalProductOrder)) {
                // Use saved global order, but validate products still exist
                const orderedProducts = [];
                const remainingProducts = [...allProducts];

                // First, add products in saved order
                config.globalProductOrder.forEach(orderedProduct => {
                    const foundIndex = remainingProducts.findIndex(p =>
                        p.id === orderedProduct.id && p.categoryKey === orderedProduct.categoryKey
                    );
                    if (foundIndex >= 0) {
                        orderedProducts.push(remainingProducts.splice(foundIndex, 1)[0]);
                    }
                });

                // Then add any new products that weren't in the saved order
                orderedProducts.push(...remainingProducts);

                currentGlobalOrder = orderedProducts;
            } else {
                // No saved order, use current order
                currentGlobalOrder = allProducts;
            }

            // Store original order
            originalGlobalOrder = [...currentGlobalOrder];

            renderOrderableProducts();
        }

        // Show empty state for ordering
        function showEmptyOrderState(message = null) {
            const container = document.getElementById('orderProductList');
            container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-info-circle"></i>
                        <h3>${message || 'No products available for ordering'}</h3>
                        <p>${message || 'Add some products first to enable global product ordering.'}</p>
                    </div>
                `;
        }

        // Render products that can be reordered globally
        function renderOrderableProducts() {
            const container = document.getElementById('orderProductList');

            const html = currentGlobalOrder.map((product, index) => {
                const productName = product.name?.en || product.name || 'Unnamed Product';
                const productTamilName = product.name?.ta || '';
                const price = product.price || 0;
                const isAvailable = product.available !== false;
                const categoryName = product.categoryName || 'Unknown Category';

                return `
                        <div class="order-item" 
                             draggable="true" 
                             data-product-index="${index}"
                             data-product-id="${product.id || index}"
                             data-category-key="${product.categoryKey}">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div class="order-item-drag-handle">
                                    <i class="fas fa-grip-vertical"></i>
                                </div>
                                <div class="order-item-position">
                                    #${index + 1}
                                </div>
                            </div>
                            <div class="order-item-info">
                                <div class="order-item-image">
                                    ${product.image || ''}
                                </div>
                                <div class="order-item-details">
                                    <h4>${productName}</h4>
                                    <p class="product-category-tag">${categoryName}</p>
                                    <p>${productTamilName ? `${productTamilName}  ` : ''}${price}  ${isAvailable ? 'Available' : 'Out of Stock'}</p>
                                </div>
                            </div>
                        </div>
                    `;
            }).join('');

            container.innerHTML = html;

            // Add drag and drop event listeners
            setupDragAndDrop();
        }

        // Setup drag and drop functionality
        function setupDragAndDrop() {
            const container = document.getElementById('orderProductList');
            const items = container.querySelectorAll('.order-item');

            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            const container = document.getElementById('orderProductList');
            container.classList.add('drop-zone');

            // Find the element we're hovering over
            const afterElement = getDragAfterElement(container, e.clientY);

            if (afterElement == null) {
                container.appendChild(draggedElement);
            } else {
                container.insertBefore(draggedElement, afterElement);
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();

            const container = document.getElementById('orderProductList');
            container.classList.remove('drop-zone');

            // Update the product order array based on new DOM order
            updateProductOrderFromDOM();

            // Re-render to update position numbers
            renderOrderableProducts();

            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            const container = document.getElementById('orderProductList');
            container.classList.remove('drop-zone');
            draggedElement = null;
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.order-item:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Update global product order array based on DOM order
        function updateProductOrderFromDOM() {
            const items = document.querySelectorAll('.order-item');
            const newOrder = [];

            items.forEach(item => {
                const originalIndex = parseInt(item.dataset.productIndex);
                if (!isNaN(originalIndex) && currentGlobalOrder[originalIndex]) {
                    newOrder.push(currentGlobalOrder[originalIndex]);
                }
            });

            currentGlobalOrder = newOrder;
        }

        // Save the new global product order
        function saveProductOrder() {
            if (currentGlobalOrder.length === 0) {
                showToast('No products to save', 'warning');
                return;
            }

            try {
                // Save global order to config
                config.globalProductOrder = currentGlobalOrder.map(product => ({
                    id: product.id,
                    categoryKey: product.categoryKey
                }));

                // Update original order for comparison
                originalGlobalOrder = [...currentGlobalOrder];

                // Mark as having changes
                markChanges();

                showToast(`Successfully saved global product order (${currentGlobalOrder.length} products)`, 'success');

            } catch (error) {
                console.error('Error saving global product order:', error);
                showToast('Error saving product order: ' + error.message, 'error');
            }
        }

        // Reset global product order to original
        function resetProductOrder() {
            if (originalGlobalOrder.length === 0) {
                showToast('No original order to reset to', 'warning');
                return;
            }

            if (confirm('Are you sure you want to reset the global product order to the original order?')) {
                currentGlobalOrder = [...originalGlobalOrder];
                renderOrderableProducts();
                showToast('Global product order reset to original order', 'info');
            }
        }

        // ===========================================
        // COMBO DEALS MANAGEMENT (New System)
        // ===========================================

        let currentComboItems = [];
        let currentComboImage = null;
        let editingComboId = null;

        function initializeCombosTab() {
            renderCombosList();
        }

        function renderCombosList() {
            const container = document.getElementById('combos-list');
            const combos = config.combos || [];

            if (combos.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-box-open"></i><p>No combos created yet. Click "Add New Combo" to get started.</p></div>';
                return;
            }

            container.innerHTML = combos.map(combo => {
                const itemNames = combo.items.map(item => {
                    const product = findProductInConfig(item.productId, item.categoryKey);
                    return product ? product.name.en : item.productId;
                }).join(' + ');

                return `
                        <div class="product-checkbox-item" style="border-bottom: 1px solid #f0f0f0; padding: 12px;">
                            <div style="flex: 1;">
                                <div class="product-checkbox-name">${combo.name.en} / ${combo.name.ta}</div>
                                <div class="product-checkbox-details">${itemNames}  ${combo.price}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-outline" onclick="editCombo('${combo.id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteCombo('${combo.id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
            }).join('');
        }

        function showComboModal(comboId = null) {
            const modal = document.getElementById('combo-modal');
            const title = document.getElementById('combo-modal-title');

            editingComboId = comboId;
            currentComboItems = [];
            currentComboImage = null;

            if (comboId) {
                title.textContent = 'Edit Combo Deal';
                const combo = config.combos.find(c => c.id === comboId);
                if (combo) {
                    document.getElementById('combo-id').value = combo.id;
                    document.getElementById('combo-name-en').value = combo.name.en;
                    document.getElementById('combo-name-ta').value = combo.name.ta;
                    document.getElementById('combo-price').value = combo.price;
                    currentComboItems = [...combo.items];
                    currentComboImage = combo.image;
                    renderComboItems();
                }
            } else {
                title.textContent = 'Add Combo Deal';
                document.getElementById('combo-form').reset();
                document.getElementById('combo-id').value = '';
                renderComboItems();
            }

            modal.classList.add('show');
        }

        function hideComboModal() {
            document.getElementById('combo-modal').classList.remove('show');
            document.getElementById('combo-form').reset();
            currentComboItems = [];
            currentComboImage = null;
            editingComboId = null;
        }

        function searchComboProducts(searchTerm) {
            const resultsContainer = document.getElementById('combo-product-search-results');

            if (!searchTerm) {
                resultsContainer.style.display = 'none';
                return;
            }

            const allProducts = [];
            Object.keys(config.products || {}).forEach(categoryKey => {
                const products = config.products[categoryKey] || [];
                products.forEach(product => {
                    allProducts.push({ ...product, categoryKey });
                });
            });

            const filtered = allProducts.filter(p =>
                p.name.en.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (p.name.ta && p.name.ta.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            if (filtered.length === 0) {
                resultsContainer.innerHTML = '<p style="padding: 8px; margin: 0;">No products found</p>';
                resultsContainer.style.display = 'block';
                return;
            }

            resultsContainer.innerHTML = filtered.map(p => `
                    <div style="padding: 8px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'" onclick="addProductToCombo('${p.id}', '${p.categoryKey}')">
                        <strong>${p.name.en}</strong>  ${p.price}
                    </div>
                `).join('');
            resultsContainer.style.display = 'block';
        }

        function addProductToCombo(productId, categoryKey) {
            const exists = currentComboItems.find(item => item.productId === productId && item.categoryKey === categoryKey);
            if (exists) {
                showToast('Product already added to combo', 'warning');
                return;
            }

            currentComboItems.push({
                productId,
                categoryKey,
                quantity: 1
            });

            renderComboItems();
            document.getElementById('combo-product-search').value = '';
            document.getElementById('combo-product-search-results').style.display = 'none';
        }

        function renderComboItems() {
            const container = document.getElementById('combo-items-list');

            if (currentComboItems.length === 0) {
                container.innerHTML = '<p class="text-muted" style="margin: 0;">No items added yet. Search and add products above.</p>';
                return;
            }

            container.innerHTML = currentComboItems.map((item, index) => {
                const product = findProductInConfig(item.productId, item.categoryKey);
                if (!product) return '';

                return `
                        <div style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #f0f0f0;">
                            <div style="flex: 1;">
                                <strong>${product.name.en}</strong><br>
                                <small>${product.price} per ${product.unit || 'unit'}</small>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <label style="margin: 0;">Qty:</label>
                                <input type="number" value="${item.quantity}" min="0.1" step="0.1" style="width: 80px; padding: 4px; border: 1px solid #dee2e6; border-radius: 4px;" onchange="updateComboItemQty(${index}, this.value)" />
                                <button class="btn btn-sm btn-danger" onclick="removeComboItem(${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
            }).join('');
        }

        function updateComboItemQty(index, qty) {
            currentComboItems[index].quantity = parseFloat(qty) || 1;
        }

        function removeComboItem(index) {
            currentComboItems.splice(index, 1);
            renderComboItems();
        }

        function handleComboImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                currentComboImage = {
                    type: 'custom',
                    src: e.target.result
                };
                const preview = document.getElementById('combo-image-preview');
                preview.querySelector('img').src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        async function generateComboCollage() {
            if (currentComboItems.length === 0) {
                showToast('Please add products first', 'warning');
                return;
            }

            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const imageSize = 200;
                const padding = 10;

                const cols = Math.min(currentComboItems.length, 2);
                const rows = Math.ceil(currentComboItems.length / cols);

                canvas.width = cols * imageSize + (cols + 1) * padding;
                canvas.height = rows * imageSize + (rows + 1) * padding;

                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                const imagePromises = currentComboItems.map((item, index) => {
                    return new Promise((resolve, reject) => {
                        const product = findProductInConfig(item.productId, item.categoryKey);
                        if (!product || !product.image) {
                            resolve(null);
                            return;
                        }

                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        img.onload = () => resolve({ img, index });
                        img.onerror = () => resolve(null);
                        img.src = product.image;
                    });
                });

                const loadedImages = await Promise.all(imagePromises);

                loadedImages.forEach((data) => {
                    if (!data) return;

                    const { img, index } = data;
                    const col = index % cols;
                    const row = Math.floor(index / cols);
                    const x = col * imageSize + (col + 1) * padding;
                    const y = row * imageSize + (row + 1) * padding;

                    ctx.drawImage(img, x, y, imageSize, imageSize);

                    ctx.strokeStyle = '#0c831f';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(x, y, imageSize, imageSize);
                });

                const collageDataUrl = canvas.toDataURL('image/png');
                currentComboImage = {
                    type: 'auto',
                    src: collageDataUrl
                };

                const preview = document.getElementById('combo-image-preview');
                preview.querySelector('img').src = collageDataUrl;
                preview.style.display = 'block';

                showToast('Collage generated successfully!', 'success');
            } catch (error) {
                console.error('Error generating collage:', error);
                showToast('Error generating collage: ' + error.message, 'error');
            }
        }

        function saveCombo(event) {
            event.preventDefault();

            const id = document.getElementById('combo-id').value || 'combo-' + Date.now();
            const nameEn = document.getElementById('combo-name-en').value.trim();
            const nameTa = document.getElementById('combo-name-ta').value.trim();
            const price = parseInt(document.getElementById('combo-price').value);

            if (!nameEn || !nameTa || !price || currentComboItems.length === 0) {
                showToast('Please fill all required fields and add at least one product', 'error');
                return;
            }

            const combo = {
                id,
                name: { en: nameEn, ta: nameTa },
                price,
                items: currentComboItems,
                image: currentComboImage || { type: 'auto', src: '' }
            };

            if (!config.combos) {
                config.combos = [];
            }

            const existingIndex = config.combos.findIndex(c => c.id === id);
            if (existingIndex >= 0) {
                config.combos[existingIndex] = combo;
            } else {
                config.combos.push(combo);
            }

            markChanges();
            showToast('Combo saved successfully', 'success');
            hideComboModal();
            renderCombosList();
        }

        function editCombo(comboId) {
            showComboModal(comboId);
        }

        function deleteCombo(comboId) {
            if (!confirm('Are you sure you want to delete this combo?')) return;

            config.combos = config.combos.filter(c => c.id !== comboId);
            markChanges();
            showToast('Combo deleted successfully', 'success');
            renderCombosList();
        }

        function findProductInConfig(productId, categoryKey) {
            const products = config.products[categoryKey] || [];
            return products.find(p => p.id === productId);
        }

        // ===========================================
        // OFFERS MANAGEMENT (Price/Qty Overrides)
        // ===========================================

        function initializeOffersTab() {
            renderOffersList();
        }

        function renderOffersList(searchTerm = '') {
            const container = document.getElementById('offers-products-list');

            if (!config.offers) {
                config.offers = [];
            }

            const allProducts = [];
            Object.keys(config.products || {}).forEach(categoryKey => {
                const products = config.products[categoryKey] || [];
                products.forEach(product => {
                    allProducts.push({
                        ...product,
                        categoryKey: categoryKey,
                        categoryName: config.categories[categoryKey]?.name?.en || categoryKey
                    });
                });
            });

            const filtered = searchTerm
                ? allProducts.filter(p =>
                    p.name.en.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (p.name.ta && p.name.ta.toLowerCase().includes(searchTerm.toLowerCase()))
                )
                : allProducts;

            container.innerHTML = filtered.map(product => {
                const existingOffer = config.offers.find(o =>
                    o.productId === product.id && o.categoryKey === product.categoryKey
                );

                return `
                        <div style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0;">
                            <div style="flex: 1;">
                                <strong>${product.name.en}</strong> / ${product.name.ta || ''}<br>
                                <small>${product.categoryName}  Original: ${product.price} per ${product.displayUnit || product.unit}</small>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <div>
                                    <label style="font-size: 0.85rem;">Override Price ()</label><br>
                                    <input type="number" value="${existingOffer?.overridePrice || ''}" placeholder="${product.price}" min="0" step="1" 
                                        style="width: 100px; padding: 6px; border: 1px solid #dee2e6; border-radius: 4px;" 
                                        onchange="updateOffer('${product.id}', '${product.categoryKey}', 'price', this.value)" />
                                </div>
                                <div>
                                    <label style="font-size: 0.85rem;">Override Qty</label><br>
                                    <input type="number" value="${existingOffer?.overrideQty || ''}" placeholder="Default" min="0.1" step="0.1" 
                                        style="width: 100px; padding: 6px; border: 1px solid #dee2e6; border-radius: 4px;" 
                                        onchange="updateOffer('${product.id}', '${product.categoryKey}', 'qty', this.value)" />
                                </div>
                                ${existingOffer ? `
                                    <button class="btn btn-sm btn-secondary" onclick="resetOffer('${product.id}', '${product.categoryKey}')">
                                        <i class="fas fa-undo"></i> Reset
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
            }).join('');
        }

        function updateOffer(productId, categoryKey, type, value) {
            if (!config.offers) {
                config.offers = [];
            }

            let offer = config.offers.find(o => o.productId === productId && o.categoryKey === categoryKey);

            if (!offer) {
                offer = { productId, categoryKey };
                config.offers.push(offer);
            }

            if (type === 'price') {
                offer.overridePrice = value ? parseInt(value) : null;
            } else if (type === 'qty') {
                offer.overrideQty = value ? parseFloat(value) : null;
            }

            if (!offer.overridePrice && !offer.overrideQty) {
                config.offers = config.offers.filter(o => o !== offer);
            }
        }

        function resetOffer(productId, categoryKey) {
            config.offers = config.offers.filter(o =>
                !(o.productId === productId && o.categoryKey === categoryKey)
            );
            renderOffersList();
        }

        function saveOffers() {
            markChanges();
            showToast(`Offers saved successfully (${config.offers.length} active)`, 'success');
        }

        // ===========================================
        // SEQUENCE MANAGEMENT (TAGS & CATEGORIES)
        // ===========================================

        function initializeSequencesTab() {
            renderTagOrderList();
            renderCategoryOrderList();

            // Setup save button
            document.getElementById('save-sequences-btn').addEventListener('click', saveSequences);
        }

        function renderTagOrderList() {
            const container = document.getElementById('tag-order-list');
            const tagOrder = config.tagOrder || ['new-arrival', 'seasonal', 'budget-pick', 'combo', 'offer', 'easy-pick'];

            if (!config.tagOrder) {
                config.tagOrder = tagOrder;
            }

            const tagNames = {
                'new-arrival': 'New Arrival',
                'seasonal': 'Seasonal',
                'budget-pick': 'Budget Pick',
                'combo': 'Combo',
                'offer': 'Offer',
                'easy-pick': 'Easy Pick'
            };

            container.innerHTML = tagOrder.map((tag, index) => `
                    <div class="sequence-item">
                        <span class="sequence-item-name">${tagNames[tag] || tag}</span>
                        <div class="sequence-item-controls">
                            <button class="sequence-btn" onclick="moveTag(${index}, -1)" ${index === 0 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-up"></i> Up
                            </button>
                            <button class="sequence-btn" onclick="moveTag(${index}, 1)" ${index === tagOrder.length - 1 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-down"></i> Down
                            </button>
                        </div>
                    </div>
                `).join('');
        }

        function moveTag(index, direction) {
            const tagOrder = config.tagOrder || [];
            const newIndex = index + direction;

            if (newIndex < 0 || newIndex >= tagOrder.length) return;

            // Swap
            [tagOrder[index], tagOrder[newIndex]] = [tagOrder[newIndex], tagOrder[index]];

            config.tagOrder = tagOrder;
            renderTagOrderList();
        }

        function renderCategoryOrderList() {
            const container = document.getElementById('category-order-list');
            const categoryOrder = config.categoryOrder || Object.keys(config.categories || {});

            if (!config.categoryOrder) {
                config.categoryOrder = categoryOrder;
            }

            container.innerHTML = categoryOrder.map((categoryKey, index) => {
                const category = config.categories[categoryKey];
                if (!category) return '';

                return `
                        <div class="sequence-item">
                            <span class="sequence-item-name">${category.icon || ''} ${category.name?.en || categoryKey}</span>
                            <div class="sequence-item-controls">
                                <button class="sequence-btn" onclick="moveCategory(${index}, -1)" ${index === 0 ? 'disabled' : ''}>
                                    <i class="fas fa-arrow-up"></i> Up
                                </button>
                                <button class="sequence-btn" onclick="moveCategory(${index}, 1)" ${index === categoryOrder.length - 1 ? 'disabled' : ''}>
                                    <i class="fas fa-arrow-down"></i> Down
                                </button>
                            </div>
                        </div>
                    `;
            }).join('');
        }

        function moveCategory(index, direction) {
            const categoryOrder = config.categoryOrder || [];
            const newIndex = index + direction;

            if (newIndex < 0 || newIndex >= categoryOrder.length) return;

            // Swap
            [categoryOrder[index], categoryOrder[newIndex]] = [categoryOrder[newIndex], categoryOrder[index]];

            config.categoryOrder = categoryOrder;
            renderCategoryOrderList();
        }

        function saveSequences() {
            try {
                markChanges();
                showToast('Tag and category sequences saved successfully', 'success');
            } catch (error) {
                showToast('Error saving sequences: ' + error.message, 'error');
            }
        }
    </script>
</body>

</html>
